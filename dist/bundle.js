(()=>{"use strict";var e,t,s,n={};n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),function(e){e[e.Empty=0]="Empty",e[e.Rat=1]="Rat",e[e.Zombie=2]="Zombie",e[e.Skeleton=3]="Skeleton",e[e.Ghost=4]="Ghost",e[e.Witch=5]="Witch",e[e.Boss=6]="Boss"}(e||(e={})),function(e){e.Small="small",e.Medium="medium",e.Large="large",e.Enormous="enormous"}(t||(t={})),function(e){e.Beginner="beginner",e.Intermediate="intermediate",e.Expert="expert",e.Master="master"}(s||(s={}));const i={[t.Small]:{width:20,height:10},[t.Medium]:{width:40,height:20},[t.Large]:{width:60,height:30},[t.Enormous]:{width:80,height:40}},a={[s.Beginner]:{minesFrequency:.15,evolutionRate:.1},[s.Intermediate]:{minesFrequency:.2,evolutionRate:.2},[s.Expert]:{minesFrequency:.25,evolutionRate:.3},[s.Master]:{minesFrequency:.3,evolutionRate:.4}},o={[s.Beginner]:1,[s.Intermediate]:1.25,[s.Expert]:1.5,[s.Master]:1.75},r={typeDistribution:{Rat:.4,Zombie:.3,Skeleton:.1,Ghost:.1,Witch:.1,Boss:0},expToNextLevel:[100,200,300,400],boardDefaults:{width:40,height:20,minesFrequency:.3,evolutionRate:.2,invertClicks:!1,removeFlags:!1},playerClass:"Warrior",monsterKeys:{0:"E",1:"R¹",2:"Z²",3:"S³",4:"G⁴",5:"W⁵",6:"B⁶"},experienceGain:{open:1,multiplicator:3},revealDelayPerCell:40,expGain:o};class l{constructor(){this._experience=0,this._health=0,this.maxHealth=0,this._level=1,this._score=0,this.heartContainers=[],this._HTMLHooks=this.loadHTMLHooks()}set experience(e){this._experience=e,this.gainLevel(),this.updateStatsheet()}get experience(){return this._experience}set health(e){this._health=e,this._health<=0&&w.getInstance().loseGame(),this.updateStatsheet()}get health(){return this._health}set level(e){this._level=e,this.updateStatsheet()}get level(){return this._level}set score(e){this._score=e,this.updateStatsheet()}get score(){return this._score}onPrimaryAction(e,t){e.click()}onSecondaryAction(e,t){e.rightClick(t)}calculateScore(e){this.score=this.experience-e,this.score<0&&(this.score=0)}calculateDamage(t){return t.type===e.Boss&&this.level>=5?0:t.type-this.level+1}getAttacked(e){this.health-=e}gainExperience(e){switch(w.getInstance().gameDifficulty){case"beginner":this.experience+=e*o.beginner;break;case"intermediate":this.experience+=e*o.intermediate;break;case"expert":this.experience+=e*o.expert;break;case"master":this.experience+=e*o.master;break;default:this.experience+=e}}debugSetExperience(e){if(e<0)throw new Error("Experience cannot be negative");this.experience=e}debugGainLevel(){this.level<5&&(this.experience=r.expToNextLevel[this.level-1])}createMemento(){return{className:this.className,experience:this.experience,health:this.health,maxHealth:this.maxHealth,level:this.level,score:this.score}}restoreFromMemento(e){this._experience=e.experience,this.maxHealth=e.maxHealth,this._health=e.health,this._level=e.level,this._score=e.score,this.updateStatsheet()}getSpecialAbility(){return null}useSpecialAbility(){}gainLevel(){this._level<5&&this.experience>=r.expToNextLevel[this.level-1]&&(this.level+=1,w.getInstance().playerUp(),this.onLevelUp())}onLevelUp(){}gainHealth(){this.health<this.maxHealth&&(this.health+=1,this.styleHearts())}importHTMLElement(e){const t=document.getElementById(e);if(!t)throw new Error("No html element with id: "+e);return t}importHTMLProgressElement(e){const t=document.getElementById(e);if(!t)throw new Error("No html element with id: "+e);return t}loadHTMLHooks(){return{playerClassSpan:this.importHTMLElement("playerClass"),playerExperienceProgress:this.importHTMLProgressElement("experience"),playerHealthDiv:this.importHTMLElement("health"),playerLevelDiv:this.importHTMLElement("playerLevel"),playerScoreDiv:this.importHTMLElement("score")}}updateStatsheet(){this._HTMLHooks.playerClassSpan.innerText=this.className,this._HTMLHooks.playerLevelDiv.innerText=this._level.toString(),0===this.heartContainers.length&&this.addHearts(),this.styleHearts(),this.updateProgress(),this._HTMLHooks.playerScoreDiv.innerText="Score: "+this._score.toString()}addHearts(){for(let e=0;e<this.maxHealth;e++){const e=document.createElement("div");e.classList.add("heart"),this.heartContainers.push(e),this._HTMLHooks.playerHealthDiv.appendChild(e)}}styleHearts(){this.heartContainers.forEach((e,t)=>{t>=this.health?e.classList.add("colored"):e.classList.remove("colored")})}updateProgress(){if(this._level<5){const e=this._level>1?r.expToNextLevel[this.level-2]:0;this._HTMLHooks.playerExperienceProgress.max=r.expToNextLevel[this.level-1]-e,this._HTMLHooks.playerExperienceProgress.value=this._experience-e}}}class c extends l{constructor(e){if(super(),this.className="Assassin",this.isExecuteModeActive=!1,!e)throw new Error("PC_Assassin requires a Board instance during construction.");this.health=2,this.maxHealth=this.health,this.updateSpecialAbilityButton()}getSpecialAbility(){return{isReady:!this.isExecuteModeActive,isWaiting:this.isExecuteModeActive}}useSpecialAbility(){this.isExecuteModeActive?this.deactivateExecuteMode():this.activateExecuteMode()}updateSpecialAbilityButton(){const e=document.getElementById("specialAbility");e&&e.classList.add("dagger")}onAnyAction(e,t){this.isExecuteModeActive&&(this.executeAssassinAttack(e),null==t||t.preventDefault(),null==t||t.stopPropagation())}onPrimaryAction(e,t){this.isExecuteModeActive?this.onAnyAction(e,t):super.onPrimaryAction(e,t)}onSecondaryAction(e,t){this.isExecuteModeActive?this.onAnyAction(e,t):super.onSecondaryAction(e,t)}activateExecuteMode(){return this.isExecuteModeActive=!0,document.body.classList.add("execute-mode-active"),K(),!0}deactivateExecuteMode(){this.isExecuteModeActive=!1,document.body.classList.remove("execute-mode-active"),K()}executeAssassinAttack(t){t.isClicked?t.clickNeighbors():(t.activateCell(0),this.level===t.type||t.type===e.Boss&&this.level>=5?t.attackPlayer(0):this.level<t.type?t.attackPlayer():t.attackPlayer(1),this.deactivateExecuteMode())}onLevelUp(){super.onLevelUp()}}c.description="The assassin is a master of targeted strikes. They can instantly defeat any monster of the same level using the execute ability.";class d extends l{constructor(e){if(super(),this.className="Mage",this._fireballAvailable=!0,this.isFireballModeActive=!1,!e)throw new Error("PC_Mage requires a Board instance during construction.");this.health=2,this.maxHealth=this.health,this.board=e}getSpecialAbility(){return{isReady:this.canCastFireball()&&!this.isFireballModeActive,isWaiting:this.isFireballModeActive}}useSpecialAbility(){this.isFireballModeActive?this.deactivateFireballMode():this.activateFireballMode()}onAnyAction(e,t){this.isFireballModeActive&&(this.castFireballOnCell(e.x,e.y),null==t||t.preventDefault(),null==t||t.stopPropagation())}onPrimaryAction(e,t){this.isFireballModeActive?this.onAnyAction(e,t):super.onPrimaryAction(e,t)}onSecondaryAction(e,t){this.isFireballModeActive?this.onAnyAction(e,t):super.onSecondaryAction(e,t)}canCastFireball(){return this._fireballAvailable}consumeFireballCharge(){this._fireballAvailable=!1}resetFireball(){this._fireballAvailable=!0,K()}activateFireballMode(){return!!this.canCastFireball()&&(this.isFireballModeActive=!0,document.body.classList.add("fireball-mode-active"),K(),!0)}deactivateFireballMode(){this.isFireballModeActive=!1,document.body.classList.remove("fireball-mode-active"),K()}castFireballOnCell(t,s){if(this.isFireballModeActive){for(let n=-1;n<=1;n++)for(let i=-1;i<=1;i++){const a=this.board.getCell(t+n,s+i);a&&!a.isClicked&&a.type===e.Empty&&a.click(0)}this.consumeFireballCharge(),this.deactivateFireballMode()}}createMemento(){const e=super.createMemento();return e.fireballAvailable=this.canCastFireball(),e}restoreFromMemento(e){super.restoreFromMemento(e),void 0!==e.fireballAvailable&&(this._fireballAvailable=e.fireballAvailable,this._fireballAvailable&&this.resetFireball()),K()}onLevelUp(){super.onLevelUp(),this.resetFireball()}}d.description="The mage can unleash a powerful 3x3 fireball. This ability recharges on every level up.";class h extends l{constructor(e){super(),this.className="Paladin",this.health=4,this.maxHealth=this.health}}h.description="The paladin is blessed with immense fortitude, starting with the highest health of all classes.";class m extends l{constructor(e){super(),this.className="Warrior",this.health=3,this.maxHealth=this.health}onLevelUp(){this.gainHealth()}}m.description="The warrior is exceptionally sturdy. They start with more health and gain an additional heart container on every level up.";class u{constructor(e,t,s,n,i,a,o){this.isClicked=!1,this.isFlagged=!1,this.type=e,this.board=t,this.x=s,this.y=n,this.HTMLElement=i,this.gameInstance=a,this.value=o}createMemento(){return{type:this.type,value:this.value,isClicked:this.isClicked,isFlagged:this.isFlagged}}restoreFromMemento(e){this.type=e.type,this.value=e.value,this.isClicked=e.isClicked,this.isFlagged=e.isFlagged}activateCell(e){this.revealCell(),this.addExperience(e)}addExperience(e){this.gameInstance.player.gainExperience(e)}attackPlayer(t){if(this.type===e.Empty)return;console.log("Monster attack! Type:",this.type,"at",this.x,this.y);const s=null!=t?t:this.gameInstance.player.calculateDamage(this);this.gameInstance.player.level>=5&&this.type===e.Boss&&s>0&&(t=0),s>0&&this.gameInstance.player.getAttacked(s),this.addExperience(this.type*r.experienceGain.multiplicator),this.gameInstance.player.health>0&&this.type===e.Boss&&this.gameInstance.winGame(),this.animateDefeat()}click(t){this.isClicked||this.isFlagged||(void 0!==this.value&&this.activateCell(r.experienceGain.open),0===this.value&&this.type===e.Empty&&this.clickNeighbors(t),this.type>0&&void 0===this.value&&(this.attackPlayer(t),this.activateCell(0)))}getBlankNeighbors(){let e=[];const{x:t,y:s,board:n}=this;for(let i=-1;i<=1;i++)for(let a=-1;a<=1;a++){const o=n.getCell(t+i,s+a);o&&0===o.value&&e.push(o)}return e}static delay(e){return new Promise(t=>setTimeout(t,e))}clickNeighbors(t){return s=this,n=void 0,a=function*(){const{x:s,y:n,board:i}=this,a=[];for(let e=-1;e<=1;e++)for(let t=-1;t<=1;t++){const o=i.getCell(s+e,n+t);!o||o.isClicked||o.isFlagged||a.push(o)}for(const s of a){if(this.gameInstance.isGameEnded())return;0===s.value?(yield u.delay(r.revealDelayPerCell),yield s.click(t)):s.type===e.Empty?(yield u.delay(r.revealDelayPerCell),s.activateCell(r.experienceGain.open)):s.type>e.Empty&&(yield u.delay(r.revealDelayPerCell),s.click(t))}},new((i=void 0)||(i=Promise))(function(e,t){function o(e){try{l(a.next(e))}catch(e){t(e)}}function r(e){try{l(a.throw(e))}catch(e){t(e)}}function l(t){var s;t.done?e(t.value):(s=t.value,s instanceof i?s:new i(function(e){e(s)})).then(o,r)}l((a=a.apply(s,n||[])).next())});var s,n,i,a}isAnyNeighborClicked(){const{x:e,y:t,board:s}=this;for(let n=-1;n<=1;n++)for(let i=-1;i<=1;i++){const a=s.getCell(e+n,t+i);if(a&&a.isClicked)return!0}return!1}revealCell(e=!1){this.isClicked||(this.isClicked=!0,this.animateReveal(e),this.updateVisuals())}rightClick(t){t.preventDefault(),this.isClicked?this.type===e.Empty&&this.clickNeighbors():(this.isFlagged=!this.isFlagged,this.updateVisuals())}translateType(t){return t>0&&void 0!==r.monsterKeys[t]?r.monsterKeys[t]:t===e.Empty?".":"?"}updateVisuals(){if(this.isFlagged?(this.HTMLElement.innerHTML="💀",this.HTMLElement.classList.add("flagged")):(this.HTMLElement.innerHTML="",this.HTMLElement.classList.remove("flagged")),this.isClicked)if(this.HTMLElement.classList.add("clicked"),this.HTMLElement.classList.add("shrinked"),this.value)this.HTMLElement.innerText=this.value.toString();else if(!this.value&&this.type>0){this.HTMLElement.innerText=this.type.toString();const e=this.translateType(this.type).replace(/[^a-zA-Z0-9_-]/g,"");this.HTMLElement.classList.add("monster",e)}else this.HTMLElement.innerText="";else this.HTMLElement.classList.remove("clicked"),this.HTMLElement.classList.remove("shrinked")}animateReveal(e=!1){e?this.HTMLElement.classList.remove("shrinked","monster-reveal-anim"):this.HTMLElement.checkVisibility()&&(this.HTMLElement.classList.remove("shrinked"),this.HTMLElement.classList.add("shrinked"),this.type>0&&(this.HTMLElement.classList.remove("monster-reveal-anim"),this.HTMLElement.offsetWidth,this.HTMLElement.classList.add("monster-reveal-anim")))}animateDefeat(){const e=this.HTMLElement,t=e.parentElement;if(!t)return;const s=e.offsetLeft+e.offsetWidth/2,n=e.offsetTop+e.offsetHeight/2,i=Math.min(e.offsetWidth,e.offsetHeight),a=1.1*i,o=.5*i;Array.from({length:3},(e,t)=>t).sort(()=>Math.random()-.5).forEach((e,i)=>{const r=document.createElement("img");r.src="./res/star.svg",r.classList.add("defeat-star");const l=.8+.6*Math.random(),c=Math.floor(360*Math.random()),d=e/3*2*Math.PI,h=.15*a,m=Math.cos(d)*(a+(Math.random()-.5)*h),u=Math.sin(d)*(a+(Math.random()-.5)*h);r.style.setProperty("--tx",`${m}px`),r.style.setProperty("--ty",`${u}px`),r.style.setProperty("--s",`${l}`),r.style.setProperty("--r",`${c}deg`),r.style.animationDelay=.08*i+"s",r.style.left=s-o/2+"px",r.style.top=n-o/2+"px",r.style.width=`${o}px`,r.style.height=`${o}px`,t.appendChild(r),r.addEventListener("animationend",()=>{r.remove()})})}}class g{constructor(e,t,s,n,i=r.typeDistribution){this.cells=[],this.validateDistribution(i),this.gameInstance=n,this._minesFrequency=s,this._width=e,this._height=t;const a=document.getElementById("app");if(!a)throw new Error("board: No #app div found");this.appElement=a,this.fillBoard(i),this.determineCellValues(),this.updateCSSVariables(e,t),this.clickHandler=this.createClickHandler(),this.contextMenuHandler=this.createContextMenuHandler(),this.addBoardEventHandlers(),this.indicateLevelGain(1)}createMemento(){return{cells:this.cells.map(e=>e.map(e=>e.createMemento()))}}restoreFromMemento(e){for(let t=0;t<this._height;t++)for(let s=0;s<this._width;s++)this.cells[t][s].restoreFromMemento(e.cells[t][s])}redraw(){this.cells.flat().forEach(e=>e.updateVisuals())}centerOnOpenedCell(){const t=this.cells.flat().find(t=>t.isClicked&&t.type===e.Empty);t&&requestAnimationFrame(()=>{t.HTMLElement.focus(),t.HTMLElement.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})})}evoluteMonster(){this.getRemainingMonster().forEach(t=>{Math.random()<=r.boardDefaults.evolutionRate&&t.type<e.Witch&&(t.type+=1)}),this.determineCellValues(),this.debug_printCellValues()}getCell(e,t){return this.cells[e]&&this.cells[e][t]?this.cells[e][t]:void 0}getCellType(t,s){return this.getCell(t,s)?this.cells[t][s].type:e.Empty}indicateLevelGain(e){if(this.appElement){for(let e=1;e<=5;e++)this.appElement.classList.remove(`level-${e}`);this.appElement.classList.add(`level-${e}`),this.appElement.classList.remove("highlight"),this.appElement.offsetWidth,this.appElement.classList.add("highlight")}}openStartArea(){let e=Math.floor(Math.random()*(this._height-1)),t=Math.floor(Math.random()*(this._width-1)),s=this.cells[e][t];for(;0!==s.value;)e=Math.round(Math.random()*(this._height-1)),t=Math.round(Math.random()*(this._width-1)),s=this.cells[e][t];s.click(),requestAnimationFrame(()=>{s.HTMLElement.focus(),s.HTMLElement.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})})}removeEventHandler(){this.appElement.removeEventListener("click",this.clickHandler),this.appElement.removeEventListener("contextmenu",this.contextMenuHandler)}removeAllFlags(){this.cells.flat().forEach(e=>{e.isFlagged&&e.type<this.gameInstance.player.level&&(e.isFlagged=!1,e.updateVisuals())})}revealBoard(e=!1){this.cells.flat().forEach(t=>{t.isClicked||(t.HTMLElement.classList.add("notClicked"),t.revealCell(e),t.isFlagged&&(t.isFlagged=!1))})}createUrn(t){const s=this._width*this._height,n=this._minesFrequency*s,i=s*(1-this._minesFrequency),a=new Array(s).fill(e.Empty,0,i-1);a.fill(e.Boss,i-1,i);const o=i+t.Rat*n,r=o+t.Zombie*n,l=r+t.Skeleton*n,c=l+t.Ghost*n,d=c+t.Witch*n,h=d+t.Boss*n;a.fill(e.Rat,i,o),a.fill(e.Zombie,o,r),a.fill(e.Skeleton,r,l),a.fill(e.Ghost,l,c),a.fill(e.Witch,c,d),a.fill(e.Boss,d,h);for(let e=a.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[a[e],a[t]]=[a[t],a[e]]}return a}determineCellValues(){this.cells.forEach((t,s)=>{t.forEach((t,n)=>{if(t.type===e.Empty){let e=0;e+=this.getCellType(s-1,n-1),e+=this.getCellType(s-1,n+0),e+=this.getCellType(s-1,n+1),e+=this.getCellType(s+0,n-1),e+=this.getCellType(s+0,n+1),e+=this.getCellType(s+1,n-1),e+=this.getCellType(s+1,n+0),e+=this.getCellType(s+1,n+1),t.value=e}})})}fillBoard(t){var s;const n=this.createUrn(t),i=document.createDocumentFragment();for(let t=0;t<this._height;t++){this.cells.push([]);for(let a=0;a<this._width;a++){const o=document.createElement("button");o.dataset.x=t.toString(),o.dataset.y=a.toString();const r=new u(null!==(s=n.pop())&&void 0!==s?s:e.Empty,this,t,a,o,this.gameInstance,void 0);i.appendChild(o),this.cells[t].push(r)}}this.appElement.appendChild(i)}getRemainingMonster(){let t=[];return this.cells.forEach(s=>{s.forEach(s=>{!s.isAnyNeighborClicked()&&s.type>e.Empty&&!s.isClicked&&t.push(s)})}),t}updateCSSVariables(e,t){const s=document.querySelector(":root");if(!s)throw new Error("No :root found");s.style.setProperty("--cols",e.toString()),s.style.setProperty("--rows",t.toString())}validateDistribution(e){let t=0;for(const[s,n]of Object.entries(e))t+=n;if(Math.abs(t-1)<1e-6)return!0;throw new Error("Provided typeDistribution doesn't sum to 1. Sum of proportions is "+t)}createClickHandler(){return e=>{const t=e.target;if(!t.dataset.x||!t.dataset.y)return;const s=this.cells[Number(t.dataset.x)][Number(t.dataset.y)];0===e.button&&(this.gameInstance.invertClicks?this.gameInstance.player.onSecondaryAction(s,e):this.gameInstance.player.onPrimaryAction(s,e))}}createContextMenuHandler(){return e=>{e.preventDefault();const t=e.target;if(!t.dataset.x||!t.dataset.y)return;const s=this.cells[Number(t.dataset.x)][Number(t.dataset.y)];this.gameInstance.invertClicks?this.gameInstance.player.onPrimaryAction(s,e):this.gameInstance.player.onSecondaryAction(s,e)}}addBoardEventHandlers(){this.appElement.addEventListener("click",this.clickHandler),this.appElement.addEventListener("contextmenu",this.contextMenuHandler)}debug_printCellValues(){let t="";t+="    ";for(let e=0;e<this._width;e++)t+=e.toString().padStart(3," ");t+="\n",this.cells.forEach((s,n)=>{let i=n.toString().padStart(3," ")+" ";s.forEach(t=>{let s=t.type===e.Empty?void 0!==t.value?t.value.toString():".":t.translateType(t.type);i+=s.toString().padStart(3," ")}),t+=i+"\n"}),console.log(t)}debug_writeValues(e){!0===e&&this.cells.forEach(e=>{e.forEach(e=>{e.type&&(e.HTMLElement.innerText=e.translateType(e.type))})})}setupDebugUI(){this.setupDebugToggle(this);const e="true"===localStorage.getItem("showDebug"),t=document.getElementById("debugLevelUp");t&&(t.style.display=e?"":"none"),this.debug_writeValues(e),this.debug_printCellValues()}setupDebugToggle(e){const t=document.getElementById("showDebug"),s=document.getElementById("debugLevelUp");if(!t||!s)return;const n="true"===localStorage.getItem("showDebug");t.checked=n,s.style.display=n?"":"none",e.debug_writeValues(n),t.addEventListener("change",()=>{const n=t.checked;s.style.display=n?"":"none",e.debug_writeValues(n),localStorage.setItem("showDebug",n?"true":"false")})}}const p="saveGame",y="gameSettings",v="leaderboard",f="instance";class b{constructor(){this.isGameEnded=!1}static getInstance(){return b.instance||(b.instance=new b),b.instance}saveGame(e){if(!this.isGameEnded)try{const t=e.createMemento();localStorage.setItem(p,JSON.stringify(t)),console.log("Game saved.")}catch(e){console.error("Could not save game state:",e)}}loadGame(){try{const e=localStorage.getItem(p);if(e){const t=JSON.parse(e);return console.log("Game loaded."),t}return null}catch(e){return console.error("Could not load game state:",e),this.deleteSave(),null}}deleteSave(){console.log("Deleting save file."),this.isGameEnded=!0,localStorage.removeItem(p)}resetGameEnded(){this.isGameEnded=!1}hasSave(){return null!==localStorage.getItem(p)}saveSettings(e){try{localStorage.setItem(y,JSON.stringify(e)),console.log("Settings saved.")}catch(e){console.error("Could not save settings:",e)}}loadSettings(e){try{const t=localStorage.getItem(y);if(t){const s=JSON.parse(t);return this.isValidGameSettings(s)?s:(console.warn("Invalid stored settings found. Clearing and using defaults."),this.deleteSettings(),e)}return e}catch(t){return console.error("Failed to parse stored settings. Clearing and using defaults.",t),this.deleteSettings(),e}}deleteSettings(){console.log("Deleting settings."),localStorage.removeItem(y)}hasSettings(){return null!==localStorage.getItem(y)}updateGameSettings(e){try{const t=this.loadGame();t?(t.gameSettings=e,localStorage.setItem(p,JSON.stringify(t)),console.log("Game settings updated in saved game.")):console.log("No saved game found to update settings.")}catch(e){console.error("Could not update game settings in saved game:",e)}}updateLeaderboard(e){try{const t=this.loadLeaderboard();t.push(e),t.sort((e,t)=>t-e);const s=t.slice(0,10);localStorage.setItem(v,JSON.stringify(s))}catch(e){console.error("Could not update leaderboard:",e)}}loadLeaderboard(){try{const e=localStorage.getItem(v);return e?JSON.parse(e):[]}catch(e){return console.error("Could not load leaderboard:",e),[]}}loadInstanceSettings(e){try{const t=localStorage.getItem(f);if(t){const s=JSON.parse(t);return this.isValidGameSettings(s)?s:(console.warn("Invalid stored instance settings found. Clearing."),this.deleteInstanceSettings(),e)}return e}catch(t){return console.error("Failed to parse stored instance settings. Clearing.",t),this.deleteInstanceSettings(),e}}deleteInstanceSettings(){console.log("Deleting instance settings."),localStorage.removeItem(f)}isValidGameSettings(e){if(!e||"object"!=typeof e)return!1;const t="string"==typeof e.boardSize,s="string"==typeof e.difficulty,n="string"==typeof e.playerClass,i="boolean"==typeof e.invertClicks,a="boolean"==typeof e.removeFlags;return t&&s&&n&&i&&a}getRawData(e){return localStorage.getItem(e)}setRawData(e,t){localStorage.setItem(e,t)}removeRawData(e){localStorage.removeItem(e)}getAllStoredData(){const e={};for(let t=0;t<localStorage.length;t++){const s=localStorage.key(t);s&&(e[s]=localStorage.getItem(s)||"")}return e}clearAllData(){localStorage.clear(),console.log("All localStorage data cleared.")}}var S,E;!function(e){e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Paused=2]="Paused",e[e.Ended=3]="Ended"}(S||(S={}));class w{constructor(){var e;this._gameTimer=0,this._gameState=S.NotStarted,this.playerClassRegistry={Assassin:c,Mage:d,Paladin:h,Warrior:m},null===(e=document.getElementById("resetButton"))||void 0===e||e.addEventListener("click",()=>this.resetGame()),this.saveManager=b.getInstance(),this._gameSettings=this.initializeGameSettings(),this.populateSettingsUIFromGameSettings();const t=()=>{this._gameState!==S.Ended&&this.saveManager.saveGame(this)};window.addEventListener("beforeunload",t),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState?(t(),this.pauseTimer()):"visible"===document.visibilityState&&this._gameState===S.Paused&&this.resumeTimer()})}static getInstance(){return w.instance||(w.instance=new w),w.instance}set board(e){this._board=e}get board(){if(!this._board)throw new Error("Board was not initialized!");return this._board}getBoardElement(){const e=document.getElementById("app");if(!e)throw new Error("Board element not found in the DOM!");return e}set player(e){this._player=e}get player(){if(!this._player)throw new Error("Player was not initialized!");return this._player}get timer(){if(this._timer)return this._timer}get invertClicks(){return this._gameSettings.invertClicks}get removeFlags(){return this._gameSettings.removeFlags}get gameDifficulty(){return this._gameSettings.difficulty}createBoard(){const e=i[this._gameSettings.boardSize],t=a[this._gameSettings.difficulty].minesFrequency;this.board=new g(e.width,e.height,t,this)}createPlayer(){const e=this.playerClassRegistry[this._gameSettings.playerClass];e?this.player=new e(this._board):(console.error(`Unknown player class: ${this._gameSettings.playerClass}. Defaulting to Warrior.`),this.player=new m(this._board))}loadDefaultSettings(){return{boardSize:t.Medium,difficulty:s.Beginner,playerClass:r.playerClass,invertClicks:r.boardDefaults.invertClicks,removeFlags:r.boardDefaults.removeFlags}}initializeGameSettings(){const e=this.loadDefaultSettings(),t=this.saveManager.loadSettings(e);return this.saveManager.hasSettings()?t:this.saveManager.loadInstanceSettings(e)}playerUp(){this.board.indicateLevelGain(this.player.level),this.board.evoluteMonster(),this._gameSettings.removeFlags&&this.board.removeAllFlags()}resetGame(){this._gameState!==S.Running&&this._gameState!==S.Paused||this.stopTimer(),this._board&&this._board.removeEventHandler(),this._gameState=S.NotStarted;const e=document.getElementById("app");e&&(e.innerHTML=""),this.resetHeartContainer(),this.saveManager.resetGameEnded(),this.startGame()}stopGame(){try{this._gameState!==S.Ended&&this.saveManager.saveGame(this)}catch(e){console.error("Error saving game state:",e)}this.stopTimer(),this._gameState=S.Ended,this._board&&this._board.removeEventHandler();const e=document.getElementById("app");e&&(e.innerHTML=""),this.resetHeartContainer()}saveSettingsFromUI(){try{try{this._gameSettings.boardSize=this.getValueFromInput("boardSize")}catch(e){console.warn("Could not save boardSize setting:",e)}try{this._gameSettings.difficulty=this.getValueFromInput("difficulty")}catch(e){console.warn("Could not save difficulty setting:",e)}try{this._gameSettings.playerClass=this.getValueFromInput("selectClass")}catch(e){console.warn("Could not save playerClass setting:",e)}try{this._gameSettings.invertClicks=this.getCheckedFromToggle("invertClicks")}catch(e){console.warn("Could not save invertClicks setting:",e)}try{this._gameSettings.removeFlags=this.getCheckedFromToggle("removeFlags")}catch(e){console.warn("Could not save removeFlags setting:",e)}this.saveManager.saveSettings(this._gameSettings),this.saveManager.updateGameSettings(this._gameSettings),this.saveManager.saveGame(this)}catch(e){console.error("Error saving settings from UI:",e)}}startGame(){var e;this._gameState!==S.Running&&(document.getElementById("modal")&&this.saveSettingsFromUI(),document.getElementById("modal")&&this.getScores(),this.createBoard(),this.createPlayer(),K(),null===(e=this._board)||void 0===e||e.openStartArea(),this.resetTimer(),this._timer=setInterval(()=>this.countSeconds(),1e3),this._gameState=S.Running,this.saveManager.saveGame(this))}winGame(){this.endGame(),this.updateLeaderboard(this.player.score),this.displayLeaderboard(`You won! Score: ${this.player.score}`)}loseGame(){this.endGame(),this.displayLeaderboard("You lost!")}pauseTimer(){this._timer&&this._gameState===S.Running&&(clearInterval(this._timer),this._timer=void 0,this._gameState=S.Paused)}resumeTimer(){this._gameState===S.Paused&&(this._timer=setInterval(()=>this.countSeconds(),1e3),this._gameState=S.Running)}updateLeaderboard(e){this.saveManager.updateLeaderboard(e)}getScores(){return this.saveManager.loadLeaderboard()}displayLeaderboard(e){$(e)}isGameEnded(){return this._gameState===S.Ended}createMemento(){return{board:this.board.createMemento(),player:this.player.createMemento(),gameTimer:this._gameTimer,gameSettings:this._gameSettings}}restoreFromMemento(e){this.isValidGameSettings(e.gameSettings)?this._gameSettings=e.gameSettings:(console.warn("Invalid game settings in memento. Deleting save and using defaults."),this.saveManager.deleteSave(),this._gameSettings=this.loadDefaultSettings()),this.populateSettingsUIFromGameSettings(),this.createBoard(),this.createPlayer(),this.board.restoreFromMemento(e.board),this.board.centerOnOpenedCell(),this.player.restoreFromMemento(e.player),this.board.indicateLevelGain(this.player.level),this._gameTimer=e.gameTimer,this._gameState=S.Paused,this.resumeTimer()}countSeconds(){this._gameTimer++,this.player.calculateScore(this._gameTimer)}endGame(){this._gameState!==S.Ended&&(this.stopTimer(),this._gameState=S.Ended,this.board.revealBoard(!0),this.saveManager.deleteSave())}getValueFromInput(e){const t=document.getElementById(e);if(t)return t.value;throw new Error(`HTML input element with id '${e}' not found.`)}getCheckedFromToggle(e){const t=document.getElementById(e);if(t)return t.checked;throw new Error(`HTML input (checkbox/toggle) element with id '${e}' not found.`)}populateSettingsUIFromGameSettings(){this.trySetInputValue("boardSize",this._gameSettings.boardSize),this.trySetInputValue("difficulty",this._gameSettings.difficulty),this.trySetInputValue("selectClass",this._gameSettings.playerClass),this.trySetToggleValue("invertClicks",this._gameSettings.invertClicks),this.trySetToggleValue("removeFlags",this._gameSettings.removeFlags)}trySetInputValue(e,t){const s=document.getElementById(e);s?s.value=t:console.warn(`HTML input element with id '${e}' not found for setting value.`)}trySetToggleValue(e,t){const s=document.getElementById(e);s&&(s.checked=t)}updateClassDescription(e){const t=this.playerClassRegistry[e];if(t){const e=document.getElementById("modal-classDescription");e&&(e.innerText=t.description)}}resetTimer(){this.stopTimer(),this._gameTimer=0;const e=document.getElementById("timer");e&&(e.innerText="00:00")}stopTimer(){clearInterval(this._timer)}resetHeartContainer(){const e=document.getElementById("health");e&&(e.innerHTML="")}isValidGameSettings(e){if(!e||"object"!=typeof e)return!1;const n=Object.values(t).includes(e.boardSize),i=Object.values(s).includes(e.difficulty),a="string"==typeof e.playerClass&&e.playerClass in this.playerClassRegistry,o="boolean"==typeof e.invertClicks,r="boolean"==typeof e.removeFlags;return!!(n&&i&&a&&o&&r)}}!function(e){e.Unimplemented="UNIMPLEMENTED",e.Unavailable="UNAVAILABLE"}(E||(E={}));class C extends Error{constructor(e,t,s){super(e),this.message=e,this.code=t,this.data=s}}const T=(e=>e.Capacitor=(e=>{const t=e.CapacitorCustomPlatform||null,s=e.Capacitor||{},n=s.Plugins=s.Plugins||{},i=()=>null!==t?t.name:(e=>{var t,s;return(null==e?void 0:e.androidBridge)?"android":(null===(s=null===(t=null==e?void 0:e.webkit)||void 0===t?void 0:t.messageHandlers)||void 0===s?void 0:s.bridge)?"ios":"web"})(e),a=e=>{var t;return null===(t=s.PluginHeaders)||void 0===t?void 0:t.find(t=>t.name===e)},o=new Map;return s.convertFileSrc||(s.convertFileSrc=e=>e),s.getPlatform=i,s.handleError=t=>e.console.error(t),s.isNativePlatform=()=>"web"!==i(),s.isPluginAvailable=e=>{const t=o.get(e);return!!(null==t?void 0:t.platforms.has(i()))||!!a(e)},s.registerPlugin=(e,r={})=>{const l=o.get(e);if(l)return console.warn(`Capacitor plugin "${e}" already registered. Cannot register plugins twice.`),l.proxy;const c=i(),d=a(e);let h;const m=n=>{let i;const a=(...a)=>{const o=(async()=>(!h&&c in r?h=h="function"==typeof r[c]?await r[c]():r[c]:null!==t&&!h&&"web"in r&&(h=h="function"==typeof r.web?await r.web():r.web),h))().then(t=>{const o=((t,n)=>{var i,a;if(!d){if(t)return null===(a=t[n])||void 0===a?void 0:a.bind(t);throw new C(`"${e}" plugin is not implemented on ${c}`,E.Unimplemented)}{const a=null==d?void 0:d.methods.find(e=>n===e.name);if(a)return"promise"===a.rtype?t=>s.nativePromise(e,n.toString(),t):(t,i)=>s.nativeCallback(e,n.toString(),t,i);if(t)return null===(i=t[n])||void 0===i?void 0:i.bind(t)}})(t,n);if(o){const e=o(...a);return i=null==e?void 0:e.remove,e}throw new C(`"${e}.${n}()" is not implemented on ${c}`,E.Unimplemented)});return"addListener"===n&&(o.remove=async()=>i()),o};return a.toString=()=>`${n.toString()}() { [capacitor code] }`,Object.defineProperty(a,"name",{value:n,writable:!1,configurable:!1}),a},u=m("addListener"),g=m("removeListener"),p=(e,t)=>{const s=u({eventName:e},t),n=async()=>{const n=await s;g({eventName:e,callbackId:n},t)},i=new Promise(e=>s.then(()=>e({remove:n})));return i.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await n()},i},y=new Proxy({},{get(e,t){switch(t){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return d?p:u;case"removeListener":return g;default:return m(t)}}});return n[e]=y,o.set(e,{name:e,proxy:y,platforms:new Set([...Object.keys(r),...d?[c]:[]])}),y},s.Exception=C,s.DEBUG=!!s.DEBUG,s.isLoggingEnabled=!!s.isLoggingEnabled,s})(e))("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==n.g?n.g:{}),L=T.registerPlugin;class x{constructor(){this.listeners={},this.retainedEventArguments={},this.windowListeners={}}addListener(e,t){let s=!1;this.listeners[e]||(this.listeners[e]=[],s=!0),this.listeners[e].push(t);const n=this.windowListeners[e];return n&&!n.registered&&this.addWindowListener(n),s&&this.sendRetainedArgumentsForEvent(e),Promise.resolve({remove:async()=>this.removeListener(e,t)})}async removeAllListeners(){this.listeners={};for(const e in this.windowListeners)this.removeWindowListener(this.windowListeners[e]);this.windowListeners={}}notifyListeners(e,t,s){const n=this.listeners[e];if(n)n.forEach(e=>e(t));else if(s){let s=this.retainedEventArguments[e];s||(s=[]),s.push(t),this.retainedEventArguments[e]=s}}hasListeners(e){var t;return!!(null===(t=this.listeners[e])||void 0===t?void 0:t.length)}registerWindowListener(e,t){this.windowListeners[t]={registered:!1,windowEventName:e,pluginEventName:t,handler:e=>{this.notifyListeners(t,e)}}}unimplemented(e="not implemented"){return new T.Exception(e,E.Unimplemented)}unavailable(e="not available"){return new T.Exception(e,E.Unavailable)}async removeListener(e,t){const s=this.listeners[e];if(!s)return;const n=s.indexOf(t);this.listeners[e].splice(n,1),this.listeners[e].length||this.removeWindowListener(this.windowListeners[e])}addWindowListener(e){window.addEventListener(e.windowEventName,e.handler),e.registered=!0}removeWindowListener(e){e&&(window.removeEventListener(e.windowEventName,e.handler),e.registered=!1)}sendRetainedArgumentsForEvent(e){const t=this.retainedEventArguments[e];t&&(delete this.retainedEventArguments[e],t.forEach(t=>{this.notifyListeners(e,t)}))}}const k=e=>encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),M=e=>e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class I extends x{async getCookies(){const e=document.cookie,t={};return e.split(";").forEach(e=>{if(e.length<=0)return;let[s,n]=e.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");s=M(s).trim(),n=M(n).trim(),t[s]=n}),t}async setCookie(e){try{const t=k(e.key),s=k(e.value),n=`; expires=${(e.expires||"").replace("expires=","")}`,i=(e.path||"/").replace("path=",""),a=null!=e.url&&e.url.length>0?`domain=${e.url}`:"";document.cookie=`${t}=${s||""}${n}; path=${i}; ${a};`}catch(e){return Promise.reject(e)}}async deleteCookie(e){try{document.cookie=`${e.key}=; Max-Age=0`}catch(e){return Promise.reject(e)}}async clearCookies(){try{const e=document.cookie.split(";")||[];for(const t of e)document.cookie=t.replace(/^ +/,"").replace(/=.*/,`=;expires=${(new Date).toUTCString()};path=/`)}catch(e){return Promise.reject(e)}}async clearAllCookies(){try{await this.clearCookies()}catch(e){return Promise.reject(e)}}}L("CapacitorCookies",{web:()=>new I});class A extends x{async request(e){const t=((e,t={})=>{const s=Object.assign({method:e.method||"GET",headers:e.headers},t),n=((e={})=>{const t=Object.keys(e);return Object.keys(e).map(e=>e.toLocaleLowerCase()).reduce((s,n,i)=>(s[n]=e[t[i]],s),{})})(e.headers)["content-type"]||"";if("string"==typeof e.data)s.body=e.data;else if(n.includes("application/x-www-form-urlencoded")){const t=new URLSearchParams;for(const[s,n]of Object.entries(e.data||{}))t.set(s,n);s.body=t.toString()}else if(n.includes("multipart/form-data")||e.data instanceof FormData){const t=new FormData;if(e.data instanceof FormData)e.data.forEach((e,s)=>{t.append(s,e)});else for(const s of Object.keys(e.data))t.append(s,e.data[s]);s.body=t;const n=new Headers(s.headers);n.delete("content-type"),s.headers=n}else(n.includes("application/json")||"object"==typeof e.data)&&(s.body=JSON.stringify(e.data));return s})(e,e.webFetchExtra),s=((e,t=!0)=>e?Object.entries(e).reduce((e,s)=>{const[n,i]=s;let a,o;return Array.isArray(i)?(o="",i.forEach(e=>{a=t?encodeURIComponent(e):e,o+=`${n}=${a}&`}),o.slice(0,-1)):(a=t?encodeURIComponent(i):i,o=`${n}=${a}`),`${e}&${o}`},"").substr(1):null)(e.params,e.shouldEncodeUrlParams),n=s?`${e.url}?${s}`:e.url,i=await fetch(n,t),a=i.headers.get("content-type")||"";let o,r,{responseType:l="text"}=i.ok?e:{};switch(a.includes("application/json")&&(l="json"),l){case"arraybuffer":case"blob":r=await i.blob(),o=await(async e=>new Promise((t,s)=>{const n=new FileReader;n.onload=()=>{const e=n.result;t(e.indexOf(",")>=0?e.split(",")[1]:e)},n.onerror=e=>s(e),n.readAsDataURL(e)}))(r);break;case"json":o=await i.json();break;default:o=await i.text()}const c={};return i.headers.forEach((e,t)=>{c[t]=e}),{data:o,headers:c,status:i.status,url:i.url}}async get(e){return this.request(Object.assign(Object.assign({},e),{method:"GET"}))}async post(e){return this.request(Object.assign(Object.assign({},e),{method:"POST"}))}async put(e){return this.request(Object.assign(Object.assign({},e),{method:"PUT"}))}async patch(e){return this.request(Object.assign(Object.assign({},e),{method:"PATCH"}))}async delete(e){return this.request(Object.assign(Object.assign({},e),{method:"DELETE"}))}}L("CapacitorHttp",{web:()=>new A});var _=function(e,t,s,n){return new(s||(s=Promise))(function(i,a){function o(e){try{l(n.next(e))}catch(e){a(e)}}function r(e){try{l(n.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(o,r)}l((n=n.apply(e,t||[])).next())})};function B(){try{return void 0!==T&&T.isNativePlatform()}catch(e){return!1}}class H{constructor(e,t){this.modalSettings={cancelButton:!1,confirmButton:!0,showClass:!0,showClassDescription:!0,showSlot:!0,showTitle:!0,showLeaderboard:!0,showSubTitle:!0},this.parentNode=e,this.modalSettings=Object.assign(Object.assign({},this.modalSettings),t);const s=document.getElementById("template-modal");if(!s)throw new Error("No modal-template found");this.node=s.content.cloneNode(!0),this.node=e.appendChild(this.node);const n=document.querySelector(".controls");if(!n)throw new Error("No controls container found in modal template");if(this.controlsContainer=n,null==t?void 0:t.customClass){const e=document.querySelector(".modal");null==e||e.classList.add(t.customClass)}if(B()){const e=document.querySelector(".modal");e&&function(e){return _(this,void 0,void 0,function*(){if(B())try{const t=(yield function(){return _(this,void 0,void 0,function*(){var e;if(!B())return 0;if("undefined"!=typeof window&&(null===(e=window.CSS)||void 0===e?void 0:e.supports)&&window.CSS.supports("padding-top: env(safe-area-inset-top)")){const e=document.createElement("div");e.style.paddingTop="env(safe-area-inset-top)",document.body.appendChild(e);const t=window.getComputedStyle(e).getPropertyValue("padding-top");if(document.body.removeChild(e),t){const e=parseInt(t,10);if(!isNaN(e)&&e>0)return e}}const t=window.devicePixelRatio||1;return Math.round(25*t)})}())+16;e.style.paddingTop=`${t}px`}catch(t){console.warn("Error adjusting modal padding for status bar:",t),e.style.paddingTop="1rem"}})}(e).catch(e=>{console.warn("Error adjusting modal padding for status bar:",e)})}this.setCancelAction(),this.parseModalSettings(),this.setClassTitle(r.playerClass),this.addEventListener()}destroyModal(){var e;null===(e=document.getElementById("modal-bg"))||void 0===e||e.remove()}parseModalSettings(){var e,t,s,n,i,a,o,r;this.modalSettings.cancelButton||null===(e=document.getElementById("modal-cancel"))||void 0===e||e.remove(),this.modalSettings.confirmButton||null===(t=document.getElementById("modal-confirm"))||void 0===t||t.remove(),this.modalSettings.title&&this.setTitle(this.modalSettings.title),this.modalSettings.subtitle&&this.setSubTitle(this.modalSettings.subtitle),this.modalSettings.text&&this.setText(this.modalSettings.text),this.modalSettings.showClass||null===(s=document.getElementById("modal-class"))||void 0===s||s.remove(),this.modalSettings.showClassDescription||null===(n=document.getElementById("modal-classDescription"))||void 0===n||n.remove(),this.modalSettings.showSlot||null===(i=document.getElementById("modal-slot"))||void 0===i||i.remove(),this.modalSettings.showTitle||null===(a=document.getElementById("modal-title"))||void 0===a||a.remove(),this.modalSettings.showSubTitle||null===(o=document.getElementById("modal-subtitle"))||void 0===o||o.remove(),this.modalSettings.showLeaderboard||null===(r=document.getElementById("modal-leaderboard"))||void 0===r||r.remove()}setSubTitle(e){const t=document.getElementById("modal-subtitle");t&&(t.innerText=e,this.setClassTitle(e))}setTitle(e){const t=document.getElementById("modal-title");t&&(t.innerText=e)}setClassTitle(e){const t=document.getElementById("modal-class");t&&(t.innerText=e)}setClassText(e){const t=document.getElementById("modal-classDescription");if(t)switch(e){case"Assassin":t.innerText="The assassin can kill monsters on his Level \n• Right click on a monster on the same level to kill it without taking damage \n• Right click on a lower level monster will give you 1 damage \n• Opening an area with right click will give you 1 damage when the area contains a monster on the same level or higher";break;case"Warrior":t.innerText="The warrior gains hearts on level up";break;case"Paladin":t.innerText="The paladin has high health to begin with";break;case"Mage":t.innerText="The mage can throw fire balls"}}setSlotContent(e){const t=document.getElementById("modal-slot");t&&(t.innerHTML=e)}setText(e){const t=document.getElementById("modal-text");t&&(t.innerText=e)}setTextAsHTML(e){const t=document.getElementById("modal-text");t&&(t.innerHTML=e)}setLeaderboardContent(e){const t=document.getElementById("modal-leaderboard");t&&(e=e.slice(0,10)).forEach(e=>{const s=document.createElement("li");s.innerText=e.toString(),t.appendChild(s)})}setDefaultClass(){const e=this.getStoredPlayerClass()||r.playerClass,t=document.getElementById("selectClass");t&&(t.value=e,this.setClassTitle(e))}getStoredPlayerClass(){let e=r.playerClass;const t=localStorage.getItem("instance");if(t)try{const s=JSON.parse(t);s.playerClass&&(e=s.playerClass)}catch(e){}return e}addCustomButton(e,t,s){const n=document.createElement("button");return n.innerText=e,n.addEventListener("click",t),(null==s?void 0:s.classes)&&n.classList.add(...s.classes),"start"===(null==s?void 0:s.position)?this.controlsContainer.prepend(n):this.controlsContainer.appendChild(n),n}setConfirmAction(e){const t=document.getElementById("modal-confirm");t&&t.addEventListener("click",()=>{e(),this.destroyModal()})}setCancelAction(e){const t=document.getElementById("modal-cancel");t&&t.addEventListener("click",()=>{e&&e(),this.destroyModal()})}addEventListener(){new MutationObserver((e,t)=>{const s=document.getElementById("selectClass");if(s){const e=w.getInstance(),n=()=>e.updateClassDescription(s.value);s.addEventListener("change",n),n(),t.disconnect()}}).observe(document.body,{childList:!0,subtree:!0})}setConfirmButtonText(e){const t=document.getElementById("modal-confirm");t&&(t.innerText=e)}setCancelButtonText(e){const t=document.getElementById("modal-cancel");t&&(t.innerText=e)}setSecondaryConfirmButtonText(e){const t=document.getElementById("modal-secondary-confirm");t&&(t.innerText=e,t.style.display="inline-block")}setSecondaryConfirmAction(e){const t=document.getElementById("modal-secondary-confirm");t&&t.addEventListener("click",()=>{e(),this.destroyModal()})}}const F={STORAGE_KEY:"theme-preference",getCurrentTheme(){const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e).theme:"system"},getSystemTheme:()=>window.matchMedia("(prefers-color-scheme: dark)").matches,setTheme(e){const t={theme:e,systemDark:this.getSystemTheme()};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)),this.applyTheme()},applyTheme(){const e=this.getCurrentTheme(),t="system"===e?this.getSystemTheme():"dark"===e;document.documentElement.classList.toggle("dark",t)},initialize(){this.applyTheme(),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{"system"===this.getCurrentTheme()&&this.applyTheme()})}},P=w.getInstance(),D=b.getInstance(),G=document.getElementById("template-startScreen"),N=document.getElementById("template-settings"),O=document.getElementById("menu"),R=document.getElementById("template-leaderboard");function U(e,t,s,n){const i=document.getElementById(e);null==i||i.addEventListener(t,s,n)}function j(){!function(e,t="flex"){e&&(e.style.display=t)}(O)}function V(){J(N,"No settings template found"),J(G,"No game initials template found");const e=new H(document.body,{showTitle:!1,showLeaderboard:!1,cancelButton:!1,showSubTitle:!1,showClass:!1,showClassDescription:!1,customClass:"start-modal"});e.setSlotContent(G.innerHTML),e.setConfirmButtonText("New Game"),e.setConfirmAction(()=>{j(),P.resetGame()}),e.addCustomButton("How to Play",()=>function(e){e.destroyModal();const t=[{title:"Welcome to sweepem!",text:"\n\t\t\t\t<p>The goal is to kill the boss. Killing the boss doesn't consume a heart.</p>\n\t\t\t\t<p>A revealed tile shows a number indicating the total strength of all adjacent monsters.</p>\n\t\t\t\t<p>🔢 Each number shows the <strong>total strength</strong> of all adjacent monsters.</p>\n\t\t\t\t<p>💀 A pink skull marks a monster you have already identified.</p>\n\n\t\t\t\t<p><strong>Example 1️⃣ (below):</strong><br>\n\t\t\t\tThe highlighted <strong>4</strong> has only one adjacent monster. <br> \n\t\t\t\t→ That means this monster has strength <strong>4</strong>.</p>\n\n\t\t\t\t<p><strong>Example 2️⃣ (below):</strong><br>\n\t\t\t\tAnother <strong>4</strong> also touches just one monster <br>\n\t\t\t\t→ this skull is also strength <strong>4</strong>.<br>\n\t\t\t\tBelow, a <strong>6</strong> is connected to two marked enemies (💀4 and 💀2).  \n\t\t\t\t✅ Since 4 + 2 = 6, all adjacent strength is already accounted for → the remaining tiles are <strong>safe to reveal</strong>.</p>\n\t\t\t",image:"./res/tutorial1.png"},{title:"Basic Controls",text:'\n\t\t\t\t<ul>\n\t\t\t\t\t<li><strong>LEFT CLICK or TAP</strong> to reveal a tile. Be careful! If it\'s a monster, you\'ll take damage.</li>\n\t\t\t\t\t<li><strong>RIGHT CLICK or HOLD TAP</strong> to place a flag on a tile you suspect hides a monster.</li>\n\t\t\t\t\t<li><strong>INVERTING CLICKS</strong> means, that the logic of the clicking or tapping is reversed.</li>\n\t\t\t\t\t<li>To use your class\'s <strong>SPECIAL ABILITY</strong> click or tap the button in the bottom right corner or in the menu, than tap on a tile.<div class="icon-container"><div class="dagger"></div><div class="fireball"></div></div></li>\n\t\t\t\t</ul>\n\t\t\t\t<p>The menu shows your current level in a circle. The progress bar shows the required experience to the next level. The hearts show your current health.</p>\n\t\t\t',image:"./res/tutorial2.png"},{title:"Monsters & Leveling",text:"\n\t\t\t\t<ul>\n\t\t\t\t\t<li>Defeat monsters and clear tiles to gain experience and level up, making you stronger and recharging your abilities!</li>\n\t\t\t\t\t<li>When you attack a monster higher than you, you get damage equal to the difference between your level and the monster's level</li>\n\t\t\t\t\t<li>The score decreases over time, so try to finish the game quickly!</li>\n\t\t\t\t</ul>\n\t\t\t",image:""},{title:"Classes & Abilities",text:"\n\t\t\t\t<h3>Class Abilities</h3>\n\t\t\t\t<ul>\n\t\t\t\t\t<li><strong>⚔️Warrior</strong> - Gains health on level up</li>\n\t\t\t\t\t<li><strong>🔥Mage</strong> - Has a fireball ability, which opens a 3x3 area</li>\n\t\t\t\t\t<li><strong>🗡️Assassin</strong> - Has the ability to execute monsters on his level</li>\n\t\t\t\t\t<li><strong>🛡️Paladin</strong> - Has high health to begin with</li>\n\t\t\t\t</ul>\n\t\t\t\t<h3>Using Abilities</h3>\n\t\t\t\t<ul>\n\t\t\t\t\t<li><strong>🔥Fireball (Mage)</strong>: Click or tap the fireball button and then click on a tile you want to attack. This opens a 3x3 area.</li>\n\t\t\t\t\t<li><strong>🗡️Execute (Assassin)</strong>: Click or tap the execute button and then click on a monster of your level to defeat it without taking damage.</li>\n\t\t\t\t</ul>\n\t\t\t",image:""}];let s=0;const n=new H(document.body,{confirmButton:!1,cancelButton:!1,showClass:!1,showClassDescription:!1,showSlot:!1,customClass:"tutorial-modal"}),i=document.getElementById("modal-image"),a=()=>{const e=t[s];n.setTitle(`Tutorial (${s+1}/${t.length})`),n.setSubTitle(e.title),n.setTextAsHTML(e.text),e.image&&i?(i.src=e.image,i.style.display="block"):i&&(i.style.display="none"),r.style.display=0===s?"none":"inline-block",l.innerText=s===t.length-1?"Finish":"Next"};n.addCustomButton("",()=>{n.destroyModal(),V()},{classes:["icon-btn","back"],position:"start"});const o=document.querySelector(".tutorial-modal");if(o){const e=document.querySelector(".back");o.insertBefore(e,o.firstChild)}const r=n.addCustomButton("Previous",()=>{s>0&&(s--,a())}),l=n.addCustomButton("Next",()=>{s<t.length-1?(s++,a()):(n.destroyModal(),V())});a()}(e),{classes:["tutorial-button"],position:"start"}),D.hasSave()&&(e.setConfirmButtonText("New Game"),e.setConfirmAction(()=>{D.deleteSave(),j(),P.resetGame()}),e.setSecondaryConfirmButtonText("Continue"),e.setSecondaryConfirmAction(()=>{const e=D.loadGame();e&&(P.restoreFromMemento(e),P.player.updateStatsheet(),P.board.redraw(),j())})),e.setDefaultClass();const t=document.getElementById("modal-debug");t&&t.remove(),setTimeout(()=>{const e=document.querySelectorAll(".arrow.left"),t=document.querySelectorAll(".arrow.right");e.forEach(e=>{e.addEventListener("click",function(){const e=this.closest(".picker-row");if(e){const t=e.querySelector("select");t&&Z(t,"left")}})}),t.forEach(e=>{e.addEventListener("click",function(){const e=this.closest(".picker-row");if(e){const t=e.querySelector("select");t&&Z(t,"right")}})})},100);const s=document.querySelector(".start-modal .icon-btn.settings");s&&s.addEventListener("click",()=>{e.destroyModal(),function(){J(N,"No settings template found");const e=new H(document.body,{showClass:!1,showClassDescription:!1,showLeaderboard:!1,cancelButton:!1,confirmButton:!1,customClass:"settings-modal"});P.pauseTimer(),e.setTitle("Game Settings"),e.setText("Please choose the settings for your next round"),e.setSlotContent(N.innerHTML),e.addCustomButton("",()=>{P.saveSettingsFromUI(),e.destroyModal(),V()},{classes:["icon-btn","back"],position:"start"});const t=document.querySelector(".settings-modal");if(t){const e=document.getElementById("modal-controls");t.insertBefore(e,t.firstChild)}e.setDefaultClass(),z(),P.populateSettingsUIFromGameSettings()}()});const n=document.querySelector(".start-modal .icon-btn.info");n&&n.addEventListener("click",()=>{e.destroyModal(),function(){const e=new H(document.body,{cancelButton:!1,confirmButton:!1,showSubTitle:!1,showClass:!1,showClassDescription:!1,showSlot:!1,customClass:"info-modal"});e.addCustomButton("",()=>{e.destroyModal(),V()},{classes:["icon-btn","back"],position:"start"});const t=document.querySelector(".info-modal");if(t){const e=document.getElementById("modal-controls");t.insertBefore(e,t.firstChild)}e.setTitle("About");e.setTextAsHTML('\n\t\t<p><strong>sweepem</strong> is a strategic blend of classic Minesweeper and a captivating RPG.</p>\n\t\t<hr>\n\t\t<h4>Crafted with ❤️</h4>\n\t\t<p>Developed and designed by <strong>Waldemar Stab</strong>.</p>\n\t\t<p>This game is a passion project. If you find a bug or have an idea for a new feature, please let me know!</p>\n\t\t<p><strong>Feedback & Bugs:</strong> <a href="https://github.com/ViatorisBaculum/sweepem" target="_blank" rel="noopener noreferrer">GitHub</a></p>\n\t\t<hr>\n\t\t<p class="copyright">Version 1.0.0<br>© 2025 Waldemar Stab. All rights reserved.</p>\n\t')}()}),P.populateSettingsUIFromGameSettings()}function $(e=""){J(R,"No leaderboard template found"),W(O),P.pauseTimer();const t=new H(document.body,{cancelButton:!1,confirmButton:!1,showSubTitle:!0,showClass:!1,showClassDescription:!1,showSlot:!1,customClass:"leaderboard-modal"});t.setTitle("Leaderboard"),t.setSubTitle(e),t.setText("These are your best scores"),t.setLeaderboardContent(D.loadLeaderboard()),t.setCancelAction(()=>{P.resumeTimer(),W(O)}),t.addCustomButton("",()=>{t.destroyModal(),P.resumeTimer(),W(O)},{classes:["icon-btn","back"],position:"start"});const s=document.querySelector(".leaderboard-modal");if(s){const e=document.getElementById("modal-controls");s.insertBefore(e,s.firstChild)}}function q(e){e&&(e.style.display="none")}function W(e,t="flex"){e&&(e.style.display=e.style.display===t?"none":t)}function z(){const e=document.getElementById("themeSelect");if(!e)return;const t=e;t.value=F.getCurrentTheme(),t.onchange=()=>F.setTheme(t.value)}function J(e,t){if(!e)throw new Error(t)}function K(){const e=document.getElementById("specialAbility");if(!e)return;const t=P.player.getSpecialAbility();t?(e.style.display="",e.classList.toggle("ability-waiting",t.isWaiting),e.classList.toggle("ability-ready",t.isReady)):e.style.display="none"}function Z(e,t){var s;const n=Array.from(e.options),i=e.selectedIndex,a="true"===(null===(s=e.closest(".picker"))||void 0===s?void 0:s.getAttribute("data-loop"));"right"===t?i<n.length-1?e.selectedIndex=i+1:a&&(e.selectedIndex=0):"left"===t&&(i>0?e.selectedIndex=i-1:a&&(e.selectedIndex=n.length-1)),e.dispatchEvent(new Event("change"))}let Y=0;document.addEventListener("touchend",function(e){const t=Date.now();t-Y<=300&&e.preventDefault(),Y=t},{passive:!1}),F.initialize(),z(),function(){const e=document.getElementById("specialAbility");e&&e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),P.player.useSpecialAbility()})}(),function(){const e=()=>{const e=document.getElementById("menu"),t=window.visualViewport;J(e,"Menu element not found"),J(t,"Visual viewport not available");const s=t.scale,n=document.documentElement.clientWidth,i=document.documentElement.clientHeight;e.style.transform=`scale(${1/s})`,e.style.transformOrigin="left bottom",e.style.left=`${t.offsetLeft+10/s}px`,e.style.width=n-40+"px",e.style.bottom=i-(t.offsetTop+t.height)+"px"},t=window.visualViewport;J(t,"Visual viewport not available"),t.addEventListener("resize",e),t.addEventListener("scroll",e)}(),V(),P.populateSettingsUIFromGameSettings(),q(O),U("openSettings","click",()=>{P.stopGame(),q(O),V()}),U("reset","click",()=>P.resetGame()),U("openLeaderboard","click",()=>$()),U("debugLevelUp","click",()=>P.player.debugGainLevel()),document.addEventListener("keydown",function(e){if("ArrowLeft"!==e.key&&"ArrowRight"!==e.key)return;const t=document.activeElement;if(t&&"SELECT"===t.tagName){e.preventDefault();const s=t;"ArrowRight"===e.key?Z(s,"right"):"ArrowLeft"===e.key&&Z(s,"left")}}),window.gameInstance=w.getInstance()})();