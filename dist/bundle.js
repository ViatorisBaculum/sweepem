(()=>{"use strict";var e,t,s;!function(e){e[e.Empty=0]="Empty",e[e.Rat=1]="Rat",e[e.Zombie=2]="Zombie",e[e.Skeleton=3]="Skeleton",e[e.Ghost=4]="Ghost",e[e.Witch=5]="Witch",e[e.Boss=6]="Boss"}(e||(e={})),function(e){e.Small="small",e.Medium="medium",e.Large="large",e.Enormous="enormous"}(t||(t={})),function(e){e.Beginner="beginner",e.Intermediate="intermediate",e.Expert="expert",e.Master="master"}(s||(s={}));const i={[t.Small]:{width:20,height:10},[t.Medium]:{width:40,height:20},[t.Large]:{width:60,height:30},[t.Enormous]:{width:80,height:40}},a={[s.Beginner]:{minesFrequency:.15,evolutionRate:.1},[s.Intermediate]:{minesFrequency:.2,evolutionRate:.2},[s.Expert]:{minesFrequency:.25,evolutionRate:.3},[s.Master]:{minesFrequency:.3,evolutionRate:.4}},n={typeDistribution:{Rat:.4,Zombie:.3,Skeleton:.1,Ghost:.1,Witch:.1,Boss:0},expToNextLevel:[100,200,300,400],boardDefaults:{width:40,height:20,minesFrequency:.3,evolutionRate:.2,invertClicks:!1,removeFlags:!1},playerClass:"Warrior",monsterKeys:{0:"E",1:"R¬π",2:"Z¬≤",3:"S¬≥",4:"G‚Å¥",5:"W‚Åµ",6:"B‚Å∂"},experienceGain:{open:1,multiplicator:3},revealDelayPerCell:40};class l{constructor(){this._experience=0,this._health=0,this.maxHealth=0,this._level=1,this._score=0,this.heartContainers=[],this._HTMLHooks=this.loadHTMLHooks()}set experience(e){this._experience=e,this.gainLevel(),this.updateStatsheet()}get experience(){return this._experience}set health(e){this._health=e,this._health<=0&&p.getInstance().loseGame(),this.updateStatsheet()}get health(){return this._health}set level(e){this._level=e,this.updateStatsheet()}get level(){return this._level}set score(e){this._score=e,this.updateStatsheet()}get score(){return this._score}onPrimaryAction(e,t){e.click()}onSecondaryAction(e,t){e.rightClick(t)}calculateScore(e){this.score=this.experience-e,this.score<0&&(this.score=0)}calculateDamage(t){return t.type===e.Boss&&this.level>=5?0:t.type-this.level+1}getAttacked(e){this.health-=e}gainExperience(e){this.experience+=e,console.log("exp",this.experience)}debugSetExperience(e){if(e<0)throw new Error("Experience cannot be negative");this.experience=e}debugGainLevel(){this.level<5&&(this.experience=n.expToNextLevel[this.level-1])}createMemento(){return{className:this.className,experience:this.experience,health:this.health,maxHealth:this.maxHealth,level:this.level,score:this.score}}restoreFromMemento(e){this._experience=e.experience,this.maxHealth=e.maxHealth,this._health=e.health,this._level=e.level,this._score=e.score,this.updateStatsheet()}getSpecialAbility(){return null}useSpecialAbility(){}gainLevel(){this._level<5&&this.experience>=n.expToNextLevel[this.level-1]&&(this.level+=1,p.getInstance().playerUp(),this.onLevelUp())}onLevelUp(){}gainHealth(){this.health<this.maxHealth&&(this.health+=1,this.styleHearts())}importHTMLElement(e){const t=document.getElementById(e);if(!t)throw new Error("No html element with id: "+e);return t}importHTMLProgressElement(e){const t=document.getElementById(e);if(!t)throw new Error("No html element with id: "+e);return t}loadHTMLHooks(){return{playerClassSpan:this.importHTMLElement("playerClass"),playerExperienceProgress:this.importHTMLProgressElement("experience"),playerHealthDiv:this.importHTMLElement("health"),playerLevelDiv:this.importHTMLElement("playerLevel"),playerScoreDiv:this.importHTMLElement("score")}}updateStatsheet(){this._HTMLHooks.playerClassSpan.innerText=this.className,this._HTMLHooks.playerLevelDiv.innerText=this._level.toString(),0===this.heartContainers.length&&this.addHearts(),this.styleHearts(),this.updateProgress(),this._HTMLHooks.playerScoreDiv.innerText="Score: "+this._score.toString()}addHearts(){for(let e=0;e<this.maxHealth;e++){const e=document.createElement("div");e.classList.add("heart"),this.heartContainers.push(e),this._HTMLHooks.playerHealthDiv.appendChild(e)}}styleHearts(){this.heartContainers.forEach(((e,t)=>{t>=this.health?e.classList.add("colored"):e.classList.remove("colored")}))}updateProgress(){if(this._level<5){const e=this._level>1?n.expToNextLevel[this.level-2]:0;this._HTMLHooks.playerExperienceProgress.max=n.expToNextLevel[this.level-1]-e,this._HTMLHooks.playerExperienceProgress.value=this._experience-e}}}class o extends l{constructor(e){super(),this.className="Assassin",this.CHORD_DELAY=2e3,this.inputState={cell:null,timer:null,isWaiting:!1},this.health=2,this.maxHealth=this.health,this.setupInputHandlers()}setupInputHandlers(){document.addEventListener("touchstart",(e=>{1===e.touches.length?this.handleFirstInput(e.target):2===e.touches.length&&this.inputState.isWaiting&&this.executeSecondInput(e)})),document.addEventListener("mousedown",(e=>{0===e.button?this.handleFirstInput(e.target):2===e.button&&this.inputState.isWaiting&&this.executeSecondInput(e)}));const e=()=>{this.inputState.timer&&clearTimeout(this.inputState.timer),this.inputState={cell:null,timer:null,isWaiting:!1}};document.addEventListener("touchend",e),document.addEventListener("mouseup",e)}handleFirstInput(e){if(!e.dataset.x||!e.dataset.y)return;const t=window.gameInstance.board;this.inputState.cell=t.cells[Number(e.dataset.x)][Number(e.dataset.y)],this.inputState.isWaiting=!0,this.inputState.timer=window.setTimeout((()=>{this.inputState={cell:null,timer:null,isWaiting:!1}}),this.CHORD_DELAY)}executeSecondInput(e){e.preventDefault(),this.inputState.timer&&(clearTimeout(this.inputState.timer),this.inputState.cell&&this.executeAssassinAttack(this.inputState.cell)),this.inputState={cell:null,timer:null,isWaiting:!1}}executeAssassinAttack(t){t.isClicked?t.clickNeighbors():(t.activateCell(0),this.level===t.type||t.type===e.Boss&&this.level>=5?t.attackPlayer(0):this.level<t.type?t.attackPlayer():t.attackPlayer(1))}}o.description="The assassin is a master of targeted strikes. They can instantly defeat any monster of the same level using a chord tap (touch with second finger while holding).";class r extends l{constructor(e){if(super(),this.className="Mage",this._fireballAvailable=!0,this.isFireballModeActive=!1,!e)throw new Error("PC_Mage requires a Board instance during construction.");this.health=2,this.maxHealth=this.health,this.board=e}getSpecialAbility(){return{isReady:this.canCastFireball()&&!this.isFireballModeActive,isWaiting:this.isFireballModeActive}}useSpecialAbility(){this.isFireballModeActive?this.deactivateFireballMode():this.activateFireballMode()}onPrimaryAction(e,t){this.isFireballModeActive?this.castFireballOnCell(e.x,e.y):super.onPrimaryAction(e,t)}canCastFireball(){return this._fireballAvailable}consumeFireballCharge(){this._fireballAvailable=!1}resetFireball(){this._fireballAvailable=!0,B()}activateFireballMode(){return!!this.canCastFireball()&&(this.isFireballModeActive=!0,document.body.classList.add("fireball-mode-active"),B(),!0)}deactivateFireballMode(){this.isFireballModeActive=!1,document.body.classList.remove("fireball-mode-active"),B()}castFireballOnCell(t,s){if(this.isFireballModeActive){for(let i=-1;i<=1;i++)for(let a=-1;a<=1;a++){const n=this.board.getCell(t+i,s+a);n&&!n.isClicked&&n.type===e.Empty&&n.click(0)}this.consumeFireballCharge(),this.deactivateFireballMode()}}createMemento(){const e=super.createMemento();return e.fireballAvailable=this.canCastFireball(),e}restoreFromMemento(e){super.restoreFromMemento(e),void 0!==e.fireballAvailable&&(this._fireballAvailable=e.fireballAvailable,this._fireballAvailable&&this.resetFireball()),B()}onLevelUp(){super.onLevelUp(),this.resetFireball()}}r.description="The mage can unleash a powerful 3x3 fireball. This ability recharges on every level up.";class c extends l{constructor(e){super(),this.className="Paladin",this.health=4,this.maxHealth=this.health}}c.description="The paladin is blessed with immense fortitude, starting with the highest health of all classes.";class h extends l{constructor(e){super(),this.className="Warrior",this.health=3,this.maxHealth=this.health}onLevelUp(){this.gainHealth()}}h.description="The warrior is exceptionally sturdy. They start with more health and gain an additional heart container on every level up.";class d{constructor(e,t,s,i,a,n,l){this.isClicked=!1,this.isFlagged=!1,this.type=e,this.board=t,this.x=s,this.y=i,this.HTMLElement=a,this.gameInstance=n,this.value=l}createMemento(){return{type:this.type,value:this.value,isClicked:this.isClicked,isFlagged:this.isFlagged}}restoreFromMemento(e){this.type=e.type,this.value=e.value,this.isClicked=e.isClicked,this.isFlagged=e.isFlagged}activateCell(e){this.revealCell(),this.addExperience(e)}addExperience(e){this.gameInstance.player.gainExperience(e)}attackPlayer(t){if(this.type===e.Empty)return;console.log("Monster attack! Type:",this.type,"at",this.x,this.y);const s=null!=t?t:this.gameInstance.player.calculateDamage(this);this.gameInstance.player.level>=5&&this.type===e.Boss&&s>0&&(t=0),s>0&&this.gameInstance.player.getAttacked(s),this.addExperience(this.type*n.experienceGain.multiplicator),this.gameInstance.player.health>0&&this.type===e.Boss&&this.gameInstance.winGame(),this.animateDefeat()}click(t){this.isClicked||this.isFlagged||(void 0!==this.value&&this.activateCell(n.experienceGain.open),0===this.value&&this.type===e.Empty&&this.clickNeighbors(t),this.type>0&&void 0===this.value&&(this.attackPlayer(t),this.activateCell(0)))}getBlankNeighbors(){let e=[];const{x:t,y:s,board:i}=this;for(let a=-1;a<=1;a++)for(let n=-1;n<=1;n++){const l=i.getCell(t+a,s+n);l&&0===l.value&&e.push(l)}return e}static delay(e){return new Promise((t=>setTimeout(t,e)))}clickNeighbors(t){return s=this,i=void 0,l=function*(){const{x:s,y:i,board:a}=this,l=[];for(let e=-1;e<=1;e++)for(let t=-1;t<=1;t++){const n=a.getCell(s+e,i+t);!n||n.isClicked||n.isFlagged||l.push(n)}for(const s of l){if(this.gameInstance.isGameEnded())return;0===s.value?(yield d.delay(n.revealDelayPerCell),yield s.click(t)):s.type===e.Empty?(yield d.delay(n.revealDelayPerCell),s.activateCell(n.experienceGain.open)):s.type>e.Empty&&(yield d.delay(n.revealDelayPerCell),s.click(t))}},new((a=void 0)||(a=Promise))((function(e,t){function n(e){try{r(l.next(e))}catch(e){t(e)}}function o(e){try{r(l.throw(e))}catch(e){t(e)}}function r(t){var s;t.done?e(t.value):(s=t.value,s instanceof a?s:new a((function(e){e(s)}))).then(n,o)}r((l=l.apply(s,i||[])).next())}));var s,i,a,l}isAnyNeighborClicked(){const{x:e,y:t,board:s}=this;for(let i=-1;i<=1;i++)for(let a=-1;a<=1;a++){const n=s.getCell(e+i,t+a);if(n&&n.isClicked)return!0}return!1}revealCell(e=!1){this.isClicked||(this.isClicked=!0,this.animateReveal(e),this.updateVisuals())}rightClick(t){t.preventDefault(),this.isClicked?this.type===e.Empty&&this.clickNeighbors():(this.isFlagged=!this.isFlagged,this.updateVisuals())}translateType(t){return t>0&&void 0!==n.monsterKeys[t]?n.monsterKeys[t]:t===e.Empty?".":"?"}updateVisuals(){if(this.isFlagged?(this.HTMLElement.innerHTML="üíÄ",this.HTMLElement.classList.add("flagged")):(this.HTMLElement.innerHTML="",this.HTMLElement.classList.remove("flagged")),this.isClicked)if(this.HTMLElement.classList.add("clicked"),this.HTMLElement.classList.add("shrinked"),this.value)this.HTMLElement.innerText=this.value.toString();else if(!this.value&&this.type>0){this.HTMLElement.innerText=this.type.toString();const e=this.translateType(this.type).replace(/[^a-zA-Z0-9_-]/g,"");this.HTMLElement.classList.add("monster",e)}else this.HTMLElement.innerText="";else this.HTMLElement.classList.remove("clicked"),this.HTMLElement.classList.remove("shrinked")}animateReveal(e=!1){e?this.HTMLElement.classList.remove("shrinked","monster-reveal-anim"):this.HTMLElement.checkVisibility()&&(this.HTMLElement.classList.remove("shrinked"),this.HTMLElement.classList.add("shrinked"),this.type>0&&(this.HTMLElement.classList.remove("monster-reveal-anim"),this.HTMLElement.offsetWidth,this.HTMLElement.classList.add("monster-reveal-anim")))}animateDefeat(){const e=this.HTMLElement,t=e.parentElement;if(!t)return;const s=e.offsetLeft+e.offsetWidth/2,i=e.offsetTop+e.offsetHeight/2,a=Math.min(e.offsetWidth,e.offsetHeight),n=1.1*a,l=.5*a;Array.from({length:3},((e,t)=>t)).sort((()=>Math.random()-.5)).forEach(((e,a)=>{const o=document.createElement("img");o.src="./res/star.svg",o.classList.add("defeat-star");const r=.8+.6*Math.random(),c=Math.floor(360*Math.random()),h=e/3*2*Math.PI,d=.15*n,m=Math.cos(h)*(n+(Math.random()-.5)*d),u=Math.sin(h)*(n+(Math.random()-.5)*d);o.style.setProperty("--tx",`${m}px`),o.style.setProperty("--ty",`${u}px`),o.style.setProperty("--s",`${r}`),o.style.setProperty("--r",`${c}deg`),o.style.animationDelay=.08*a+"s",o.style.left=s-l/2+"px",o.style.top=i-l/2+"px",o.style.width=`${l}px`,o.style.height=`${l}px`,t.appendChild(o),o.addEventListener("animationend",(()=>{o.remove()}))}))}}class m{constructor(e,t,s,i,a=n.typeDistribution){this.cells=[],this.validateDistribution(a),this.gameInstance=i,this._minesFrequency=s,this._width=e,this._height=t;const l=document.getElementById("app");if(!l)throw new Error("board: No #app div found");this.appElement=l,this.fillBoard(a),this.determineCellValues(),this.updateCSSVariables(e,t),this.clickHandler=this.createClickHandler(),this.contextMenuHandler=this.createContextMenuHandler(),this.addBoardEventHandlers(),this.indicateLevelGain(1)}createMemento(){return{cells:this.cells.map((e=>e.map((e=>e.createMemento()))))}}restoreFromMemento(e){for(let t=0;t<this._height;t++)for(let s=0;s<this._width;s++)this.cells[t][s].restoreFromMemento(e.cells[t][s])}redraw(){this.cells.flat().forEach((e=>e.updateVisuals()))}centerOnOpenedCell(){const t=this.cells.flat().find((t=>t.isClicked&&t.type===e.Empty));t&&requestAnimationFrame((()=>{t.HTMLElement.focus(),t.HTMLElement.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})}))}evoluteMonster(){this.getRemainingMonster().forEach((t=>{Math.random()<=n.boardDefaults.evolutionRate&&t.type<e.Witch&&(t.type+=1)})),this.determineCellValues(),this.debug_printCellValues()}getCell(e,t){return this.cells[e]&&this.cells[e][t]?this.cells[e][t]:void 0}getCellType(t,s){return this.getCell(t,s)?this.cells[t][s].type:e.Empty}indicateLevelGain(e){if(this.appElement){for(let e=1;e<=5;e++)this.appElement.classList.remove(`level-${e}`);this.appElement.classList.add(`level-${e}`),this.appElement.classList.remove("highlight"),this.appElement.offsetWidth,this.appElement.classList.add("highlight")}}openStartArea(){let e=Math.floor(Math.random()*(this._height-1)),t=Math.floor(Math.random()*(this._width-1)),s=this.cells[e][t];for(;0!==s.value;)e=Math.round(Math.random()*(this._height-1)),t=Math.round(Math.random()*(this._width-1)),s=this.cells[e][t];s.click(),requestAnimationFrame((()=>{s.HTMLElement.focus(),s.HTMLElement.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})}))}removeEventHandler(){this.appElement.removeEventListener("click",this.clickHandler),this.appElement.removeEventListener("contextmenu",this.contextMenuHandler)}removeAllFlags(){this.cells.flat().forEach((e=>{e.isFlagged&&e.type<this.gameInstance.player.level&&(e.isFlagged=!1,e.updateVisuals())}))}revealBoard(e=!1){this.cells.flat().forEach((t=>{t.isClicked||(t.HTMLElement.classList.add("notClicked"),t.revealCell(e),t.isFlagged&&(t.isFlagged=!1))}))}createUrn(t){const s=this._width*this._height,i=this._minesFrequency*s,a=s*(1-this._minesFrequency),n=new Array(s).fill(e.Empty,0,a-1);n.fill(e.Boss,a-1,a);const l=a+t.Rat*i,o=l+t.Zombie*i,r=o+t.Skeleton*i,c=r+t.Ghost*i,h=c+t.Witch*i,d=h+t.Boss*i;n.fill(e.Rat,a,l),n.fill(e.Zombie,l,o),n.fill(e.Skeleton,o,r),n.fill(e.Ghost,r,c),n.fill(e.Witch,c,h),n.fill(e.Boss,h,d);for(let e=n.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[n[e],n[t]]=[n[t],n[e]]}return n}determineCellValues(){this.cells.forEach(((t,s)=>{t.forEach(((t,i)=>{if(t.type===e.Empty){let e=0;e+=this.getCellType(s-1,i-1),e+=this.getCellType(s-1,i+0),e+=this.getCellType(s-1,i+1),e+=this.getCellType(s+0,i-1),e+=this.getCellType(s+0,i+1),e+=this.getCellType(s+1,i-1),e+=this.getCellType(s+1,i+0),e+=this.getCellType(s+1,i+1),t.value=e}}))}))}fillBoard(t){var s;const i=this.createUrn(t),a=document.createDocumentFragment();for(let t=0;t<this._height;t++){this.cells.push([]);for(let n=0;n<this._width;n++){const l=document.createElement("button");l.dataset.x=t.toString(),l.dataset.y=n.toString();const o=new d(null!==(s=i.pop())&&void 0!==s?s:e.Empty,this,t,n,l,this.gameInstance,void 0);a.appendChild(l),this.cells[t].push(o)}}this.appElement.appendChild(a)}getRemainingMonster(){let t=[];return this.cells.forEach((s=>{s.forEach((s=>{!s.isAnyNeighborClicked()&&s.type>e.Empty&&!s.isClicked&&t.push(s)}))})),t}updateCSSVariables(e,t){const s=document.querySelector(":root");if(!s)throw new Error("No :root found");s.style.setProperty("--cols",e.toString()),s.style.setProperty("--rows",t.toString())}validateDistribution(e){let t=0;for(const[s,i]of Object.entries(e))t+=i;if(Math.abs(t-1)<1e-6)return!0;throw new Error("Provided typeDistribution doesn't sum to 1. Sum of proportions is "+t)}createClickHandler(){return e=>{const t=e.target;if(!t.dataset.x||!t.dataset.y)return;const s=this.cells[Number(t.dataset.x)][Number(t.dataset.y)];0===e.button&&(this.gameInstance.invertClicks?this.gameInstance.player.onSecondaryAction(s,e):this.gameInstance.player.onPrimaryAction(s,e))}}createContextMenuHandler(){return e=>{e.preventDefault();const t=e.target;if(!t.dataset.x||!t.dataset.y)return;const s=this.cells[Number(t.dataset.x)][Number(t.dataset.y)];this.gameInstance.invertClicks?this.gameInstance.player.onPrimaryAction(s,e):this.gameInstance.player.onSecondaryAction(s,e)}}addBoardEventHandlers(){this.appElement.addEventListener("click",this.clickHandler),this.appElement.addEventListener("contextmenu",this.contextMenuHandler)}debug_printCellValues(){let t="";t+="    ";for(let e=0;e<this._width;e++)t+=e.toString().padStart(3," ");t+="\n",this.cells.forEach(((s,i)=>{let a=i.toString().padStart(3," ")+" ";s.forEach((t=>{let s=t.type===e.Empty?void 0!==t.value?t.value.toString():".":t.translateType(t.type);a+=s.toString().padStart(3," ")})),t+=a+"\n"})),console.log(t)}debug_writeValues(e){!0===e&&this.cells.forEach((e=>{e.forEach((e=>{e.type&&(e.HTMLElement.innerText=e.translateType(e.type))}))}))}setupDebugUI(){this.setupDebugToggle(this);const e="true"===localStorage.getItem("showDebug"),t=document.getElementById("debugLevelUp");t&&(t.style.display=e?"":"none"),this.debug_writeValues(e),this.debug_printCellValues()}setupDebugToggle(e){const t=document.getElementById("showDebug"),s=document.getElementById("debugLevelUp");if(!t||!s)return;const i="true"===localStorage.getItem("showDebug");t.checked=i,s.style.display=i?"":"none",e.debug_writeValues(i),t.addEventListener("change",(()=>{const i=t.checked;s.style.display=i?"":"none",e.debug_writeValues(i),localStorage.setItem("showDebug",i?"true":"false")}))}}const u={saveKey:"saveGame",isGameEnded:!1,saveGame(){if(!this.isGameEnded)try{const e=window.gameInstance.createMemento();localStorage.setItem(this.saveKey,JSON.stringify(e)),console.log("Game saved.")}catch(e){console.error("Could not save game state:",e)}},loadGame(){try{const e=localStorage.getItem(this.saveKey);if(e){const t=JSON.parse(e);return console.log("Game loaded."),t}return null}catch(e){return console.error("Could not load game state:",e),this.deleteSave(),null}},deleteSave(){console.log("Deleting save file."),this.isGameEnded=!0,localStorage.removeItem(this.saveKey)},hasSave(){return null!==localStorage.getItem(this.saveKey)}};var g;!function(e){e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Paused=2]="Paused",e[e.Ended=3]="Ended"}(g||(g={}));class p{constructor(){var e;this._gameTimer=0,this._gameState=g.NotStarted,this.playerClassRegistry={Assassin:o,Mage:r,Paladin:c,Warrior:h},null===(e=document.getElementById("resetButton"))||void 0===e||e.addEventListener("click",(()=>this.resetGame())),this._gameSettings=this.initializeGameSettings(),this.populateSettingsUIFromGameSettings();const t=()=>{this._gameState!==g.Ended&&u.saveGame()};window.addEventListener("beforeunload",t),document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?(t(),this.pauseTimer()):"visible"===document.visibilityState&&this._gameState===g.Paused&&this.resumeTimer()}))}static getInstance(){return p.instance||(p.instance=new p),p.instance}set board(e){this._board=e}get board(){if(!this._board)throw new Error("Board was not initialized!");return this._board}getBoardElement(){const e=document.getElementById("app");if(!e)throw new Error("Board element not found in the DOM!");return e}set player(e){this._player=e}get player(){if(!this._player)throw new Error("Player was not initialized!");return this._player}get timer(){if(this._timer)return this._timer}get invertClicks(){return this._gameSettings.invertClicks}get removeFlags(){return this._gameSettings.removeFlags}createBoard(){const e=i[this._gameSettings.boardSize],t=a[this._gameSettings.difficulty].minesFrequency;this.board=new m(e.width,e.height,t,this)}createPlayer(){const e=this.playerClassRegistry[this._gameSettings.playerClass];e?this.player=new e(this._board):(console.error(`Unknown player class: ${this._gameSettings.playerClass}. Defaulting to Warrior.`),this.player=new h(this._board))}loadDefaultSettings(){return{boardSize:t.Medium,difficulty:s.Beginner,playerClass:n.playerClass,invertClicks:n.boardDefaults.invertClicks,removeFlags:n.boardDefaults.removeFlags}}initializeGameSettings(){const e=this.loadDefaultSettings(),t=localStorage.getItem("instance");if(!t)return e;try{const s=JSON.parse(t);return this.isValidGameSettings(s)?s:(console.warn("Invalid stored settings found. Clearing and using defaults."),localStorage.removeItem("instance"),e)}catch(t){return console.error("Failed to parse stored settings. Clearing and using defaults.",t),localStorage.removeItem("instance"),e}}playerUp(){this.board.indicateLevelGain(this.player.level),this.board.evoluteMonster(),this._gameSettings.removeFlags&&this.board.removeAllFlags()}resetGame(){this._gameState!==g.Running&&this._gameState!==g.Paused||this.stopTimer(),this._board&&this._board.removeEventHandler(),this._gameState=g.NotStarted;const e=document.getElementById("app");e&&(e.innerHTML=""),this.resetHeartContainer(),this.startGame()}stopGame(){try{this._gameState!==g.Ended&&u.saveGame()}catch(e){console.error("Error saving game state:",e)}this.stopTimer(),this._gameState=g.Ended,this._board&&this._board.removeEventHandler();const e=document.getElementById("app");e&&(e.innerHTML=""),this.resetHeartContainer()}saveSettingsFromUI(){try{try{this._gameSettings.boardSize=this.getValueFromInput("boardSize")}catch(e){console.warn("Could not save boardSize setting:",e)}try{this._gameSettings.difficulty=this.getValueFromInput("difficulty")}catch(e){console.warn("Could not save difficulty setting:",e)}try{this._gameSettings.playerClass=this.getValueFromInput("selectClass")}catch(e){console.warn("Could not save playerClass setting:",e)}try{this._gameSettings.invertClicks=this.getCheckedFromToggle("invertClicks")}catch(e){console.warn("Could not save invertClicks setting:",e)}try{this._gameSettings.removeFlags=this.getCheckedFromToggle("removeFlags")}catch(e){console.warn("Could not save removeFlags setting:",e)}localStorage.setItem("instance",JSON.stringify(this._gameSettings))}catch(e){console.error("Error saving settings from UI:",e)}}startGame(){var e;this._gameState!==g.Running&&(document.getElementById("modal")&&this.saveSettingsFromUI(),document.getElementById("modal")&&this.getScores(),this.createBoard(),this.createPlayer(),B(),null===(e=this._board)||void 0===e||e.openStartArea(),this.resetTimer(),this._timer=setInterval((()=>this.countSeconds()),1e3),this._gameState=g.Running,u.isGameEnded=!1)}winGame(){this.endGame(),this.updateLeaderboard(this.player.score),this.displayLeaderboard(`You won! Score: ${this.player.score}`)}loseGame(){this.endGame(),this.displayLeaderboard("You lost!")}pauseTimer(){this._timer&&this._gameState===g.Running&&(clearInterval(this._timer),this._timer=void 0,this._gameState=g.Paused)}resumeTimer(){this._gameState===g.Paused&&(this._timer=setInterval((()=>this.countSeconds()),1e3),this._gameState=g.Running)}updateLeaderboard(e){const t="leaderboard",s=JSON.parse(localStorage.getItem(t)||"[]");s.push(e),s.sort(((e,t)=>t-e));const i=s.slice(0,10);localStorage.setItem(t,JSON.stringify(i))}getScores(){return JSON.parse(localStorage.getItem("leaderboard")||"[]")}displayLeaderboard(e){x(e)}isGameEnded(){return this._gameState===g.Ended}createMemento(){return{board:this.board.createMemento(),player:this.player.createMemento(),gameTimer:this._gameTimer,gameSettings:this._gameSettings}}restoreFromMemento(e){this.isValidGameSettings(e.gameSettings)?this._gameSettings=e.gameSettings:(console.warn("Invalid game settings in memento. Deleting save and using defaults."),u.deleteSave(),this._gameSettings=this.loadDefaultSettings()),this.populateSettingsUIFromGameSettings(),this.createBoard(),this.createPlayer(),this.board.restoreFromMemento(e.board),this.board.centerOnOpenedCell(),this.player.restoreFromMemento(e.player),this._gameTimer=e.gameTimer,this._gameState=g.Paused,this.resumeTimer()}countSeconds(){this._gameTimer++,this.player.calculateScore(this._gameTimer)}endGame(){this._gameState!==g.Ended&&(this.stopTimer(),this._gameState=g.Ended,this.board.revealBoard(!0),u.deleteSave())}getValueFromInput(e){const t=document.getElementById(e);if(t)return t.value;throw new Error(`HTML input element with id '${e}' not found.`)}getCheckedFromToggle(e){const t=document.getElementById(e);if(t)return t.checked;throw new Error(`HTML input (checkbox/toggle) element with id '${e}' not found.`)}populateSettingsUIFromGameSettings(){this.trySetInputValue("boardSize",this._gameSettings.boardSize),this.trySetInputValue("difficulty",this._gameSettings.difficulty),this.trySetInputValue("selectClass",this._gameSettings.playerClass),this.trySetToggleValue("invertClicks",this._gameSettings.invertClicks),this.trySetToggleValue("removeFlags",this._gameSettings.removeFlags)}trySetInputValue(e,t){const s=document.getElementById(e);s?s.value=t:console.warn(`HTML input element with id '${e}' not found for setting value.`)}trySetToggleValue(e,t){const s=document.getElementById(e);s&&(s.checked=t)}updateClassDescription(e){const t=this.playerClassRegistry[e];if(t){const e=document.getElementById("modal-classDescription");e&&(e.innerText=t.description)}}resetTimer(){this.stopTimer(),this._gameTimer=0;const e=document.getElementById("timer");e&&(e.innerText="00:00")}stopTimer(){clearInterval(this._timer)}resetHeartContainer(){const e=document.getElementById("health");e&&(e.innerHTML="")}isValidGameSettings(e){if(!e||"object"!=typeof e)return!1;const i=Object.values(t).includes(e.boardSize),a=Object.values(s).includes(e.difficulty),n="string"==typeof e.playerClass&&e.playerClass in this.playerClassRegistry,l="boolean"==typeof e.invertClicks,o="boolean"==typeof e.removeFlags;return!!(i&&a&&n&&l&&o)}}class y{constructor(e,t){this.modalSettings={cancelButton:!1,confirmButton:!0,showClass:!0,showClassDescription:!0,showSlot:!0,showTitle:!0,showSubTitle:!0},this.parentNode=e,this.modalSettings=Object.assign(Object.assign({},this.modalSettings),t);const s=document.getElementById("template-modal");if(!s)throw new Error("No modal-template found");this.node=s.content.cloneNode(!0),this.node=e.appendChild(this.node);const i=document.querySelector(".controls");if(!i)throw new Error("No controls container found in modal template");if(this.controlsContainer=i,null==t?void 0:t.customClass){const e=document.querySelector(".modal");null==e||e.classList.add(t.customClass)}this.setCancelAction(),this.parseModalSettings(),this.setClassTitle(n.playerClass),this.addEventListener()}destroyModal(){var e;null===(e=document.getElementById("modal-bg"))||void 0===e||e.remove()}parseModalSettings(){var e,t,s,i,a,n,l;this.modalSettings.cancelButton||null===(e=document.getElementById("modal-cancel"))||void 0===e||e.remove(),this.modalSettings.confirmButton||null===(t=document.getElementById("modal-confirm"))||void 0===t||t.remove(),this.modalSettings.title&&this.setTitle(this.modalSettings.title),this.modalSettings.subtitle&&this.setSubTitle(this.modalSettings.subtitle),this.modalSettings.text&&this.setText(this.modalSettings.text),this.modalSettings.showClass||null===(s=document.getElementById("modal-class"))||void 0===s||s.remove(),this.modalSettings.showClassDescription||null===(i=document.getElementById("modal-classDescription"))||void 0===i||i.remove(),this.modalSettings.showSlot||null===(a=document.getElementById("modal-slot"))||void 0===a||a.remove(),this.modalSettings.showTitle||null===(n=document.getElementById("modal-title"))||void 0===n||n.remove(),this.modalSettings.showSubTitle||null===(l=document.getElementById("modal-subtitle"))||void 0===l||l.remove()}setSubTitle(e){const t=document.getElementById("modal-subtitle");t&&(t.innerText=e,this.setClassTitle(e))}setTitle(e){const t=document.getElementById("modal-title");t&&(t.innerText=e)}setClassTitle(e){const t=document.getElementById("modal-class");t&&(t.innerText=e)}setClassText(e){const t=document.getElementById("modal-classDescription");if(t)switch(e){case"Assassin":t.innerText="The assassin can kill monsters on his Level \n‚Ä¢ Right click on a monster on the same level to kill it without taking damage \n‚Ä¢ Right click on a lower level monster will give you 1 damage \n‚Ä¢ Opening an area with right click will give you 1 damage when the area contains a monster on the same level or higher";break;case"Warrior":t.innerText="The warrior gains hearts on level up";break;case"Paladin":t.innerText="The paladin has high health to begin with";break;case"Mage":t.innerText="The mage can throw fire balls"}}setSlotContent(e){const t=document.getElementById("modal-slot");t&&(t.innerHTML=e)}setText(e){const t=document.getElementById("modal-text");t&&(t.innerText=e)}setLeaderboardContent(e){const t=document.getElementById("modal-leaderboard");t&&(e=e.slice(0,10)).forEach((e=>{const s=document.createElement("li");s.innerText=e.toString(),t.appendChild(s)}))}setDefaultClass(){const e=this.getStoredPlayerClass()||n.playerClass,t=document.getElementById("selectClass");t&&(t.value=e,this.setClassTitle(e))}getStoredPlayerClass(){let e=n.playerClass;const t=localStorage.getItem("instance");if(t)try{const s=JSON.parse(t);s.playerClass&&(e=s.playerClass)}catch(e){}return e}addCustomButton(e,t,s){const i=document.createElement("button");return i.innerText=e,i.addEventListener("click",t),(null==s?void 0:s.classes)&&i.classList.add(...s.classes),"start"===(null==s?void 0:s.position)?this.controlsContainer.prepend(i):this.controlsContainer.appendChild(i),i}setConfirmAction(e){const t=document.getElementById("modal-confirm");t&&t.addEventListener("click",(()=>{e(),this.destroyModal()}))}setCancelAction(e){const t=document.getElementById("modal-cancel");t&&t.addEventListener("click",(()=>{e&&e(),this.destroyModal()}))}addEventListener(){new MutationObserver(((e,t)=>{const s=document.getElementById("selectClass");if(s){const e=p.getInstance(),i=()=>e.updateClassDescription(s.value);s.addEventListener("change",i),i(),t.disconnect()}})).observe(document.body,{childList:!0,subtree:!0})}setConfirmButtonText(e){const t=document.getElementById("modal-confirm");t&&(t.innerText=e)}setCancelButtonText(e){const t=document.getElementById("modal-cancel");t&&(t.innerText=e)}setSecondaryConfirmButtonText(e){const t=document.getElementById("modal-secondary-confirm");t&&(t.innerText=e,t.style.display="inline-block")}setSecondaryConfirmAction(e){const t=document.getElementById("modal-secondary-confirm");t&&t.addEventListener("click",(()=>{e(),this.destroyModal()}))}}const v={STORAGE_KEY:"theme-preference",getCurrentTheme(){const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e).theme:"system"},getSystemTheme:()=>window.matchMedia("(prefers-color-scheme: dark)").matches,setTheme(e){const t={theme:e,systemDark:this.getSystemTheme()};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)),this.applyTheme()},applyTheme(){const e=this.getCurrentTheme(),t="system"===e?this.getSystemTheme():"dark"===e;document.documentElement.classList.toggle("dark",t)},initialize(){this.applyTheme(),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(()=>{"system"===this.getCurrentTheme()&&this.applyTheme()}))}},f=p.getInstance(),S=document.getElementById("template-startScreen"),b=document.getElementById("template-settings"),E=document.getElementById("menu"),C=document.getElementById("template-leaderboard");function T(e,t,s,i){const a=document.getElementById(e);null==a||a.addEventListener(t,s,i)}function w(){!function(e,t="flex"){e&&(e.style.display=t)}(E)}function L(){_(b,"No settings template found"),_(S,"No game initials template found");const e=new y(document.body,{showTitle:!1,cancelButton:!1,showSubTitle:!1,showClass:!1,showClassDescription:!1,customClass:"start-modal"});e.setSlotContent(S.innerHTML),e.setConfirmButtonText("New Game"),e.setConfirmAction((()=>{w(),f.resetGame()})),e.addCustomButton("How to Play",(()=>function(e){e.destroyModal();const t=[{title:"Welcome to DungeonSweeper!",text:"The goal is to kill the boss. A revealed tile shows a number indicating the total strength of all adjacent monsters. \n\nThe highlighted 4 indicates, that the sum of the adjacent monsters is 4. So, in this case, the 3 and the 1 are adjacent to the 4.",image:"./res/tutorial4.png"},{title:"Basic Controls",text:"LEFT CLICK to reveal a tile. Be careful! If it's a monster, you'll take damage.\n\nRIGHT CLICK to place a flag on a tile you suspect hides a monster.\n\nOn mobile you have to touch and hold on the tile to imitate an right click.",image:"./res/tutorial1.png"},{title:"Monsters & Leveling",text:"Clicking a monster damages you. \n\nStronger monsters deal more damage. \n\nDefeat monsters and clear tiles to gain experience and level up, making you stronger and recharging your abilities!",image:"./res/tutorial2.png"},{title:"Classes & Abilities",text:"Each class has unique powers. The Warrior gains health on level up, the Mage has a fireball, and the Assassin can execute enemies with a right-click. Choose wisely! \n\nTo use the fireball, you have to click the fireball button and then click on a tile you want to attack. This opens a 3x3 area.\n\nTo use the Assassin's special ability, you have to click on a monster with a right click. If the monster is of the same level as you, you won't take any damage.",image:""}];let s=0;const i=new y(document.body,{confirmButton:!1,cancelButton:!1,showClass:!1,showClassDescription:!1,showSlot:!1,customClass:"tutorial-modal"}),a=document.getElementById("modal-image"),n=()=>{const e=t[s];i.setTitle(`Tutorial (${s+1}/${t.length})`),i.setSubTitle(e.title),i.setText(e.text),e.image&&a?(a.src=e.image,a.style.display="block"):a&&(a.style.display="none"),l.style.display=0===s?"none":"inline-block",o.innerText=s===t.length-1?"Finish":"Next"},l=i.addCustomButton("Previous",(()=>{s>0&&(s--,n())})),o=i.addCustomButton("Next",(()=>{s<t.length-1?(s++,n()):(i.destroyModal(),L())}));n()}(e)),{classes:["tutorial-button"],position:"start"}),u.hasSave()&&(e.setConfirmButtonText("New Game"),e.setConfirmAction((()=>{u.deleteSave(),w(),f.resetGame()})),e.setSecondaryConfirmButtonText("Continue"),e.setSecondaryConfirmAction((()=>{const e=u.loadGame();e&&(f.restoreFromMemento(e),f.player.updateStatsheet(),f.board.redraw(),w())}))),e.setDefaultClass();const t=document.getElementById("modal-debug");t&&t.remove(),setTimeout((()=>{const e=document.querySelectorAll(".arrow.left"),t=document.querySelectorAll(".arrow.right");e.forEach((e=>{e.addEventListener("click",(function(){const e=this.closest(".picker-row");if(e){const t=e.querySelector("select");t&&H(t,"left")}}))})),t.forEach((e=>{e.addEventListener("click",(function(){const e=this.closest(".picker-row");if(e){const t=e.querySelector("select");t&&H(t,"right")}}))}))}),100);const s=document.querySelector(".start-modal .icon-btn.settings");s&&s.addEventListener("click",(()=>{e.destroyModal(),function(){_(b,"No settings template found");const e=new y(document.body,{cancelButton:!1,confirmButton:!1});f.pauseTimer(),e.setTitle("Game Settings"),e.setText("Please choose the settings for your next round"),e.setSlotContent(b.innerHTML),e.addCustomButton("Back to Start",(()=>{f.saveSettingsFromUI(),e.destroyModal(),L()}),{position:"start"}),e.setDefaultClass(),I(),f.populateSettingsUIFromGameSettings();try{f.board.setupDebugUI()}catch(e){}}()}));const i=document.querySelector(".start-modal .icon-btn.info");i&&i.addEventListener("click",(()=>{e.destroyModal(),function(){const e=new y(document.body,{cancelButton:!1,confirmButton:!1,showSubTitle:!1,showClass:!1,showClassDescription:!1,showSlot:!1,customClass:"info-modal"});e.addCustomButton("",(()=>{e.destroyModal(),L()}),{classes:["icon-btn","back"],position:"start"});const t=document.querySelector(".info-modal");if(t){const e=document.getElementById("modal-controls");t.insertBefore(e,t.firstChild)}e.setTitle("About DungeonSweeper"),e.setText("DungeonSweeper is a game inspired by Minesweeper, with RPG elements. Explore dungeons, defeat monsters, and level up your hero!")}()})),f.populateSettingsUIFromGameSettings()}function x(e=""){_(C,"No leaderboard template found"),M(E),f.pauseTimer();const t=new y(document.body,{cancelButton:!0,confirmButton:!1,showSubTitle:!0,showClass:!1,showClassDescription:!1,showSlot:!1,customClass:"leaderboard-modal"});t.setTitle("Leaderboard"),t.setSubTitle(e),t.setText("These are your best scores"),t.setLeaderboardContent(f.getScores()),t.setCancelAction((()=>{f.resumeTimer(),M(E)}))}function k(e){e&&(e.style.display="none")}function M(e,t="flex"){e&&(e.style.display=e.style.display===t?"none":t)}function I(){const e=document.getElementById("themeSelect");if(!e)return;const t=e;t.value=v.getCurrentTheme(),t.onchange=()=>v.setTheme(t.value)}function _(e,t){if(!e)throw new Error(t)}function B(){const e=document.getElementById("specialAbility");if(!e)return;const t=f.player.getSpecialAbility();t?(e.style.display="",e.classList.toggle("ability-waiting",t.isWaiting),e.classList.toggle("ability-ready",t.isReady)):e.style.display="none"}function H(e,t){var s;const i=Array.from(e.options),a=e.selectedIndex,n="true"===(null===(s=e.closest(".picker"))||void 0===s?void 0:s.getAttribute("data-loop"));"right"===t?a<i.length-1?e.selectedIndex=a+1:n&&(e.selectedIndex=0):"left"===t&&(a>0?e.selectedIndex=a-1:n&&(e.selectedIndex=i.length-1)),e.dispatchEvent(new Event("change"))}document.addEventListener("touchstart",(function(e){e.touches.length>1&&e.preventDefault()}),{passive:!1}),v.initialize(),I(),function(){const e=document.getElementById("specialAbility");e&&e.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),f.player.useSpecialAbility()}))}(),L(),f.populateSettingsUIFromGameSettings(),k(E),T("openSettings","click",(()=>{f.stopGame(),k(E),L()})),T("reset","click",(()=>f.resetGame())),T("openLeaderboard","click",(()=>x())),T("debugLevelUp","click",(()=>f.player.debugGainLevel())),document.addEventListener("keydown",(function(e){if("ArrowLeft"!==e.key&&"ArrowRight"!==e.key)return;const t=document.activeElement;if(t&&"SELECT"===t.tagName){e.preventDefault();const s=t;"ArrowRight"===e.key?H(s,"right"):"ArrowLeft"===e.key&&H(s,"left")}})),window.gameInstance=p.getInstance()})();